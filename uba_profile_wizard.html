<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBA 프로파일 마법사</title>
    <!-- API 스크립트 추가 -->
    <script src="js/api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: #e2e8f0;
            min-height: 100vh;
            font-size: 0.9rem; /* 기본 폰트 크기 축소 */
        }

        .wizard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem; /* 패딩 축소 */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem; /* 마진 축소 */
        }

        .header h1 {
            font-size: 2rem; /* 제목 크기 축소 */
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.3rem; /* 마진 축소 */
        }

        .header p {
            color: #94a3b8;
            font-size: 0.95rem; /* 크기 축소 */
        }

        .progress-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem; /* 마진 축소 */
            gap: 0.5rem; /* 간격 축소 */
        }

        .progress-step {
            display: flex;
            align-items: center;
        }

        .step-circle {
            width: 32px; /* 크기 축소 */
            height: 32px; /* 크기 축소 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }

        .step-circle.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .step-circle.inactive {
            background: #374151;
            color: #9ca3af;
        }

        .step-label {
            margin-left: 0.5rem; /* 마진 축소 */
            font-size: 0.8rem; /* 크기 축소 */
            color: #94a3b8;
        }

        .wizard-content {
            flex: 1;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem; /* 패딩 축소 */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .step-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 1rem; /* 마진 축소 */
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem; /* 마진 축소 */
            font-weight: 600;
            color: #f1f5f9;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem; /* 패딩 축소 */
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 0.5rem;
            color: #e2e8f0;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* 열 너비 축소 */
            gap: 0.75rem; /* 간격 축소 */
            margin-top: 0.5rem; /* 마진 축소 */
        }

        .radio-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem; /* 패딩 축소 */
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(51, 65, 85, 0.3);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.15); /* 그림자 축소 */
        }

        .radio-item.selected {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
        }

        .radio-item input[type="radio"] {
            width: 16px; /* 크기 축소 */
            height: 16px; /* 크기 축소 */
            margin-right: 0.75rem; /* 마진 축소 */
            margin-top: 0.25rem;
            accent-color: #6366f1;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            line-height: 1.3;
            flex: 1;
        }

        .radio-item label strong {
            display: block;
            color: #f1f5f9;
            font-size: 0.95rem; /* 크기 축소 */
            margin-bottom: 0.25rem; /* 마진 축소 */
        }

        .radio-description {
            display: block;
            color: #94a3b8;
            font-size: 0.8rem; /* 크기 축소 */
            font-weight: normal;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* 열 너비 축소 */
            gap: 0.75rem; /* 간격 축소 */
            margin-top: 0.5rem; /* 마진 축소 */
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.6rem; /* 패딩 축소 */
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.3);
            border-radius: 0.4rem; /* 둥글기 축소 */
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: #6366f1;
            transform: translateY(-1px); /* 변화량 축소 */
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem; /* 마진 축소 */
            accent-color: #6366f1;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 0.6rem; /* 둥글기 축소 */
            padding: 1rem; /* 패딩 축소 */
            margin-bottom: 0.75rem; /* 마진 축소 */
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.1); /* 그림자 축소 */
        }

        .metric-card h4 {
            color: #6366f1;
            margin-bottom: 0.3rem; /* 마진 축소 */
            font-size: 1rem; /* 크기 축소 */
        }

        .metric-card p {
            color: #94a3b8;
            font-size: 0.85rem; /* 크기 축소 */
            line-height: 1.4;
        }

        .metric-card.disabled {
            opacity: 0.4;
            pointer-events: none;
            background: rgba(15, 23, 42, 0.3);
            border-color: rgba(51, 65, 85, 0.2);
        }

        .metric-card.disabled h4 {
            color: #64748b;
        }

        .metric-unavailable {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 0.4rem; /* 패딩 축소 */
            border-radius: 0.4rem; /* 둥글기 축소 */
            font-size: 0.8rem; /* 크기 축소 */
            margin-top: 0.3rem; /* 마진 축소 */
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem; /* 마진 축소 */
            padding-top: 1rem; /* 패딩 축소 */
            border-top: 1px solid rgba(51, 65, 85, 0.3);
        }

        .btn {
            padding: 0.5rem 1.5rem; /* 패딩 축소 */
            border: none;
            border-radius: 0.4rem; /* 둥글기 축소 */
            font-size: 0.9rem; /* 크기 축소 */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #5856eb, #7c3aed);
            transform: translateY(-1px); /* 변화량 축소 */
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); /* 그림자 축소 */
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.7);
            color: #e2e8f0;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(51, 65, 85, 0.9);
            transform: translateY(-1px); /* 변화량 축소 */
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 0.75rem; /* 패딩 축소 */
            border-radius: 0.4rem; /* 둥글기 축소 */
            margin-bottom: 1rem; /* 마진 축소 */
            border: 1px solid;
            font-size: 0.85rem; /* 크기 축소 */
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* 열 너비 축소 */
            gap: 1rem; /* 간격 축소 */
            margin-top: 1rem; /* 마진 축소 */
        }

        .summary-card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(51, 65, 85, 0.3);
            border-radius: 0.6rem; /* 둥글기 축소 */
            padding: 1rem; /* 패딩 축소 */
        }

        .summary-card h4 {
            color: #f1f5f9;
            margin-bottom: 0.75rem; /* 마진 축소 */
            font-size: 0.95rem; /* 크기 축소 */
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem; /* 마진 축소 */
            padding-bottom: 0.3rem; /* 패딩 축소 */
            border-bottom: 1px solid rgba(51, 65, 85, 0.2);
            font-size: 0.85rem; /* 크기 축소 */
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .tag {
            display: inline-block;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 0.2rem 0.5rem; /* 패딩 축소 */
            border-radius: 9999px;
            font-size: 0.7rem; /* 크기 축소 */
            font-weight: 500;
            margin: 0.1rem; /* 마진 축소 */
        }

        .select-all-btn {
            display: flex;
            align-items: center;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
            padding: 0.3rem 0.75rem; /* 패딩 축소 */
            border-radius: 0.4rem; /* 둥글기 축소 */
            font-size: 0.8rem; /* 크기 축소 */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .select-all-btn:hover {
            background: rgba(99, 102, 241, 0.25);
            transform: translateY(-1px);
        }

        .select-all-btn input[type="checkbox"] {
            accent-color: #6366f1;
        }

        .selected-count {
            font-size: 0.75rem; /* 크기 축소 */
            color: #94a3b8;
            background: rgba(15, 23, 42, 0.6);
            padding: 0.2rem 0.6rem; /* 패딩 축소 */
            border-radius: 0.3rem; /* 둥글기 축소 */
        }

        /* Step 내 제목 크기 축소 */
        .step-content h3 {
            margin-bottom: 1rem !important; /* 마진 축소 */
            color: #f1f5f9;
            font-size: 1.2rem !important; /* 크기 축소 */
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .wizard-container { padding: 0.75rem; }
            .progress-bar { flex-direction: column; align-items: center; gap: 0.5rem; }
            .button-group { flex-direction: column; gap: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <div class="header">
            <h1>UBA 프로파일 마법사</h1>
            <p>사용자 및 엔터티 행동 분석 프로파일을 쉽게 설정하세요</p>
        </div>

        <div class="progress-bar">
            <div class="progress-step">
                <div class="step-circle active" id="step1">1</div>
                <div class="step-label">기본 정보</div>
            </div>
            <div class="progress-step">
                <div class="step-circle inactive" id="step2">2</div>
                <div class="step-label">데이터 소스</div>
            </div>
            <div class="progress-step">
                <div class="step-circle inactive" id="step3">3</div>
                <div class="step-label">분석 메트릭</div>
            </div>
            <div class="progress-step">
                <div class="step-circle inactive" id="step4">4</div>
                <div class="step-label">임계값 설정</div>
            </div>
            <div class="progress-step">
                <div class="step-circle inactive" id="step5">5</div>
                <div class="step-label">검토 및 완료</div>
            </div>
        </div>

        <div class="wizard-content">
            <!-- Step 1: 기본 정보 -->
            <div class="step-content active" id="content1">
                <h3 style="margin-bottom: 2rem; color: #f1f5f9; font-size: 1.5rem;">UBA 프로파일 기본 정보</h3>

                <div class="form-group">
                    <label for="profileName">프로파일 이름 *</label>
                    <input type="text" id="profileName" placeholder="예: 일반 사용자 행동 프로파일">
                </div>

                <div class="form-group">
                    <label for="profileDescription">설명</label>
                    <textarea id="profileDescription" rows="3" placeholder="이 프로파일이 분석하는 행동 패턴에 대한 설명을 입력하세요"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="profileType">프로파일 유형</label>
                        <select id="profileType">
                            <option value="user">사용자 프로파일</option>
                            <option value="entity">엔터티 프로파일</option>
                            <option value="hybrid">하이브리드 프로파일</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="analysisScope">분석 범위</label>
                        <select id="analysisScope">
                            <option value="department">부서별</option>
                            <option value="role">역할별</option>
                            <option value="global">전체 조직</option>
                        </select>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>정보:</strong> UBA 프로파일은 정상적인 사용자 행동 패턴을 학습하여 이상 징후를 탐지합니다.
                </div>
            </div>

            <!-- Step 2: 데이터 소스 -->
            <div class="step-content" id="content2">
                <h3 style="margin-bottom: 2rem; color: #f1f5f9; font-size: 1.5rem;">데이터 소스 선택</h3>

                <div class="form-group">
                    <label>로그 소스 선택 * (하나만 선택)</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="windowsLogs" name="logSource" value="windows">
                            <label for="windowsLogs">
                                <strong>Windows 이벤트 로그</strong>
                                <span class="radio-description">로그인, 로그아웃, 시스템 이벤트</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="adLogs" name="logSource" value="ad">
                            <label for="adLogs">
                                <strong>Active Directory</strong>
                                <span class="radio-description">사용자 인증, 권한 변경, 그룹 관리</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="firewallLogs" name="logSource" value="firewall">
                            <label for="firewallLogs">
                                <strong>방화벽 로그</strong>
                                <span class="radio-description">네트워크 트래픽, IP 접근 패턴</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="proxyLogs" name="logSource" value="proxy">
                            <label for="proxyLogs">
                                <strong>프록시/웹 로그</strong>
                                <span class="radio-description">웹 사이트 접근, URL 패턴</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="vpnLogs" name="logSource" value="vpn">
                            <label for="vpnLogs">
                                <strong>VPN 로그</strong>
                                <span class="radio-description">원격 접속, 지역별 연결 패턴</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="dnsLogs" name="logSource" value="dns">
                            <label for="dnsLogs">
                                <strong>DNS 로그</strong>
                                <span class="radio-description">도메인 요청, DNS 쿼리 패턴</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="emailLogs" name="logSource" value="email">
                            <label for="emailLogs">
                                <strong>이메일 로그</strong>
                                <span class="radio-description">이메일 송수신, 첨부파일 패턴</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="linuxLogs" name="logSource" value="linux">
                            <label for="linuxLogs">
                                <strong>리눅스/유닉스 로그</strong>
                                <span class="radio-description">syslog, auth.log, secure, 시스템 이벤트</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="dbLogs" name="logSource" value="database">
                            <label for="dbLogs">
                                <strong>데이터베이스 로그</strong>
                                <span class="radio-description">데이터 접근, 쿼리 실행 패턴</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="learningPeriod">학습 기간</label>
                    <select id="learningPeriod">
                        <option value="7">7일</option>
                        <option value="14">14일</option>
                        <option value="30" selected>30일</option>
                        <option value="60">60일</option>
                        <option value="90">90일</option>
                    </select>
                </div>

                <div class="alert alert-info">
                    <strong>권장사항:</strong> 정확한 베이스라인 설정을 위해 최소 30일간의 학습 기간을 권장합니다.
                </div>
            </div>

            <!-- Step 3: 분석 메트릭 -->
            <div class="step-content" id="content3">
                <h3 style="margin-bottom: 2rem; color: #f1f5f9; font-size: 1.5rem;">분석 메트릭 설정</h3>

                <div id="selectedLogInfo" class="alert alert-info" style="display: none;">
                    <strong>선택된 로그 소스:</strong> <span id="logSourceName">-</span><br>
                    <strong>분석 가능한 메트릭:</strong> <span id="availableMetrics">-</span>
                </div>

                <div class="metric-card" id="timeMetricCard">
                    <h4>📅 시간 기반 분석</h4>
                    <p>사용자의 시간적 행동 패턴을 분석하여 이상 징후를 탐지합니다.</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.75rem 0;">
                        <button type="button" id="selectAllTimeBtn" class="select-all-btn">
                            <span>전체 선택</span>
                            <input type="checkbox" id="selectAllTime" style="margin-left: 8px;">
                        </button>
                        <span id="timeSelectedCount" class="selected-count">0개 선택됨</span>
                    </div>
                    <div class="checkbox-group" style="margin-top: 1rem;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="loginTime" value="login_time">
                            <label for="loginTime">로그인 시간 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sessionDuration" value="session_duration">
                            <label for="sessionDuration">세션 지속 시간</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="afterHours" value="after_hours">
                            <label for="afterHours">업무시간 외 활동</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="weekendActivity" value="weekend_activity">
                            <label for="weekendActivity">주말/휴일 접근</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="loginFrequency" value="login_frequency">
                            <label for="loginFrequency">로그인 빈도 변화</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sessionOverlap" value="session_overlap">
                            <label for="sessionOverlap">동시 세션 탐지</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="idleTime" value="idle_time">
                            <label for="idleTime">비활성 시간 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="timeZoneAnomaly" value="timezone_anomaly">
                            <label for="timeZoneAnomaly">시간대 이상 접근</label>
                        </div>
                    </div>
                    <div id="timeMetricUnavailable" class="metric-unavailable" style="display: none;">
                        이 로그 소스에서는 시간 기반 분석이 제한적이거나 불가능합니다.
                    </div>
                </div>

                <div class="metric-card" id="networkMetricCard">
                    <h4>🌐 네트워크 기반 분석</h4>
                    <p>네트워크 접근 패턴과 지리적 위치를 분석하여 이상 징후를 탐지합니다.</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.75rem 0;">
                        <button type="button" id="selectAllNetworkBtn" class="select-all-btn">
                            <span>전체 선택</span>
                            <input type="checkbox" id="selectAllNetwork" style="margin-left: 8px;">
                        </button>
                        <span id="networkSelectedCount" class="selected-count">0개 선택됨</span>
                    </div>
                    <div class="checkbox-group" style="margin-top: 1rem;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ipAddress" value="ip_address">
                            <label for="ipAddress">IP 주소 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="geoLocation" value="geo_location">
                            <label for="geoLocation">지리적 위치 분석</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dataVolume" value="data_volume">
                            <label for="dataVolume">데이터 전송량</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="impossibleTravel" value="impossible_travel">
                            <label for="impossibleTravel">불가능한 이동 탐지</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="vpnUsage" value="vpn_usage">
                            <label for="vpnUsage">VPN 사용 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="networkDevice" value="network_device">
                            <label for="networkDevice">디바이스 변경 탐지</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bandwidthUsage" value="bandwidth_usage">
                            <label for="bandwidthUsage">대역폭 사용량 이상</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="connectionPattern" value="connection_pattern">
                            <label for="connectionPattern">연결 패턴 분석</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="proxyBypass" value="proxy_bypass">
                            <label for="proxyBypass">프록시 우회 시도</label>
                        </div>
                    </div>
                    <div id="networkMetricUnavailable" class="metric-unavailable" style="display: none;">
                        이 로그 소스에서는 네트워크 기반 분석이 제한적이거나 불가능합니다.
                    </div>
                </div>

                <div class="metric-card" id="accessMetricCard">
                    <h4>🔐 접근 기반 분석</h4>
                    <p>시스템 리소스 접근 패턴과 권한 사용을 분석하여 이상 징후를 탐지합니다.</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.75rem 0;">
                        <button type="button" id="selectAllAccessBtn" class="select-all-btn">
                            <span>전체 선택</span>
                            <input type="checkbox" id="selectAllAccess" style="margin-left: 8px;">
                        </button>
                        <span id="accessSelectedCount" class="selected-count">0개 선택됨</span>
                    </div>
                    <div class="checkbox-group" style="margin-top: 1rem;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="resourceAccess" value="resource_access">
                            <label for="resourceAccess">리소스 접근 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="authFailures" value="auth_failures">
                            <label for="authFailures">인증 실패 횟수</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="privilegeEscalation" value="privilege_escalation">
                            <label for="privilegeEscalation">권한 상승 시도</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sensitiveDataAccess" value="sensitive_data">
                            <label for="sensitiveDataAccess">민감 데이터 접근</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fileDownload" value="file_download">
                            <label for="fileDownload">파일 다운로드 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="adminAccess" value="admin_access">
                            <label for="adminAccess">관리자 권한 사용</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="applicationUsage" value="app_usage">
                            <label for="applicationUsage">애플리케이션 사용 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="databaseQuery" value="db_query">
                            <label for="databaseQuery">데이터베이스 쿼리 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="emailBehavior" value="email_behavior">
                            <label for="emailBehavior">이메일 행동 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="systemCommand" value="system_command">
                            <label for="systemCommand">시스템 명령어 실행</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="remoteAccess" value="remote_access">
                            <label for="remoteAccess">원격 접근 패턴</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="shareAccess" value="share_access">
                            <label for="shareAccess">공유 폴더 접근</label>
                        </div>
                    </div>
                    <div id="accessMetricUnavailable" class="metric-unavailable" style="display: none;">
                        이 로그 소스에서는 접근 기반 분석이 제한적이거나 불가능합니다.
                    </div>
                </div>
            </div>

            <!-- Step 4: 임계값 설정 -->
            <div class="step-content" id="content4">
                <h3 style="margin-bottom: 2rem; color: #f1f5f9; font-size: 1.5rem;">이상 징후 임계값 설정</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div class="form-group">
                        <label for="anomalyThreshold">이상 징후 민감도</label>
                        <select id="anomalyThreshold">
                            <option value="low">낮음 (보수적)</option>
                            <option value="medium" selected>보통 (권장)</option>
                            <option value="high">높음 (민감함)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="alertSeverity">경고 심각도</label>
                        <select id="alertSeverity">
                            <option value="info">정보</option>
                            <option value="low">낮음</option>
                            <option value="medium" selected>보통</option>
                            <option value="high">높음</option>
                            <option value="critical">매우 높음</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="riskScore">위험 점수 임계값 (1-100)</label>
                    <input type="range" id="riskScore" min="1" max="100" value="70" style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.9rem; color: #94a3b8;">
                        <span>1 (낮음)</span>
                        <span id="riskScoreValue">70</span>
                        <span>100 (높음)</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>알림 설정</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="emailAlert" value="email" checked>
                            <label for="emailAlert">이메일 알림</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="slackAlert" value="slack">
                            <label for="slackAlert">Slack 알림</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="smsAlert" value="sms">
                            <label for="smsAlert">SMS 알림</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dashboardAlert" value="dashboard" checked>
                            <label for="dashboardAlert">대시보드 표시</label>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>참고:</strong> 임계값이 낮을수록 더 많은 이상 징후를 탐지하지만, 오탐률도 증가할 수 있습니다.
                </div>
            </div>

            <!-- Step 5: 검토 및 완료 -->
            <div class="step-content" id="content5">
                <h3 style="margin-bottom: 2rem; color: #f1f5f9; font-size: 1.5rem;">설정 검토 및 완료</h3>

                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>📋 기본 정보</h4>
                        <div class="summary-item">
                            <span>프로파일 이름:</span>
                            <span id="summaryName">-</span>
                        </div>
                        <div class="summary-item">
                            <span>프로파일 유형:</span>
                            <span id="summaryType">-</span>
                        </div>
                        <div class="summary-item">
                            <span>분석 범위:</span>
                            <span id="summaryScope">-</span>
                        </div>
                    </div>

                    <div class="summary-card">
                        <h4>📊 데이터 소스</h4>
                        <div class="summary-item">
                            <span>학습 기간:</span>
                            <span id="summaryLearning">-</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div id="summaryDataSources">선택된 소스가 없습니다</div>
                        </div>
                    </div>

                    <div class="summary-card">
                        <h4>📈 분석 메트릭</h4>
                        <div id="summaryMetrics">선택된 메트릭이 없습니다</div>
                    </div>

                    <div class="summary-card">
                        <h4>⚠️ 알림 설정</h4>
                        <div class="summary-item">
                            <span>민감도:</span>
                            <span id="summarySensitivity">-</span>
                        </div>
                        <div class="summary-item">
                            <span>위험 점수 임계값:</span>
                            <span id="summaryRiskScore">-</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div id="summaryAlerts">알림 설정이 없습니다</div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>다음 단계:</strong> 프로파일 생성 후 시스템이 자동으로 학습을 시작합니다. 초기 베이스라인 설정까지 약 24-48시간이 소요될 수 있습니다.
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="prevBtn" onclick="prevStep()" disabled>
                ← 이전
            </button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                다음 →
            </button>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;

        // 전체 선택 버튼 이벤트 리스너 설정
        document.getElementById('selectAllTimeBtn').addEventListener('click', function() {
            const checkbox = document.getElementById('selectAllTime');
            checkbox.checked = !checkbox.checked;

            // 모든 활성화된 시간 기반 체크박스에 적용
            const timeCheckboxes = document.querySelectorAll('#timeMetricCard input[type="checkbox"]:not(#selectAllTime):not(:disabled)');
            timeCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });

            updateSelectedCount('time');
        });

        document.getElementById('selectAllNetworkBtn').addEventListener('click', function() {
            const checkbox = document.getElementById('selectAllNetwork');
            checkbox.checked = !checkbox.checked;

            // 모든 활성화된 네트워크 기반 체크박스에 적용
            const networkCheckboxes = document.querySelectorAll('#networkMetricCard input[type="checkbox"]:not(#selectAllNetwork):not(:disabled)');
            networkCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });

            updateSelectedCount('network');
        });

        document.getElementById('selectAllAccessBtn').addEventListener('click', function() {
            const checkbox = document.getElementById('selectAllAccess');
            checkbox.checked = !checkbox.checked;

            // 모든 활성화된 접근 기반 체크박스에 적용
            const accessCheckboxes = document.querySelectorAll('#accessMetricCard input[type="checkbox"]:not(#selectAllAccess):not(:disabled)');
            accessCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });

            updateSelectedCount('access');
        });

        // 전체 선택 체크박스에도 이벤트 리스너 추가
        document.getElementById('selectAllTime').addEventListener('change', function() {
            const timeCheckboxes = document.querySelectorAll('#timeMetricCard input[type="checkbox"]:not(#selectAllTime):not(:disabled)');
            timeCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });

            updateSelectedCount('time');
        });

        document.getElementById('selectAllNetwork').addEventListener('change', function() {
            const networkCheckboxes = document.querySelectorAll('#networkMetricCard input[type="checkbox"]:not(#selectAllNetwork):not(:disabled)');
            networkCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });

            updateSelectedCount('network');
        });

        document.getElementById('selectAllAccess').addEventListener('change', function() {
            const accessCheckboxes = document.querySelectorAll('#accessMetricCard input[type="checkbox"]:not(#selectAllAccess):not(:disabled)');
            accessCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });

            updateSelectedCount('access');
        });

        // 체크박스 상태에 따라 선택된 항목 수 업데이트
        function updateSelectedCount(type) {
            const cardId = type + 'MetricCard';
            const counterId = type + 'SelectedCount';
            const checkboxes = document.querySelectorAll(`#${cardId} input[type="checkbox"]:not(#selectAll${type.charAt(0).toUpperCase() + type.slice(1)}):not(:disabled):checked`);
            document.getElementById(counterId).textContent = `${checkboxes.length}개 선택됨`;
        }

        // 경고 심각도와 위험 점수 임계값 매핑 정의
        const severityRiskScoreMapping = {
            // 심각도 → 위험 점수 범위 (중간값)
            'info': 10,      // 정보: 0-20 (중간값 10)
            'low': 25,       // 낮음: 21-40 (중간값 25)
            'medium': 55,    // 보통: 41-70 (중간값 55)
            'high': 80,      // 높음: 71-90 (중간값 80)
            'critical': 95   // 매우 높음: 91-100 (중간값 95)
        };

        // 위험 점수 → 경고 심각도 매핑
        function getRiskScoreToSeverity(riskScore) {
            if (riskScore <= 20) return 'info';      // 정보
            else if (riskScore <= 40) return 'low';       // 낮음
            else if (riskScore <= 70) return 'medium';    // 보통
            else if (riskScore <= 90) return 'high';      // 높음
            else return 'critical';                       // 매우 높음
        }

        // 경고 심각도 변경 시 위험 점수 자동 조정 (연동 플래그로 무한루프 방지)
        let isSeverityUpdating = false;
        function onAlertSeverityChange() {
            if (isSeverityUpdating) return;

            const alertSeverity = document.getElementById('alertSeverity').value;
            const targetRiskScore = severityRiskScoreMapping[alertSeverity];

            if (targetRiskScore !== undefined) {
                isSeverityUpdating = true;
                document.getElementById('riskScore').value = targetRiskScore;
                document.getElementById('riskScoreValue').textContent = targetRiskScore;
                console.log(`경고 심각도 "${alertSeverity}" → 위험 점수 ${targetRiskScore}로 자동 조정`);
                isSeverityUpdating = false;
            }
        }

        // 위험 점수 변경 시 경고 심각도 자동 조정 (연동 플래그로 무한루프 방지)
        let isRiskScoreUpdating = false;
        function onRiskScoreChange() {
            if (isRiskScoreUpdating) return;

            const riskScore = parseInt(document.getElementById('riskScore').value);
            const targetSeverity = getRiskScoreToSeverity(riskScore);

            isRiskScoreUpdating = true;
            document.getElementById('alertSeverity').value = targetSeverity;
            document.getElementById('riskScoreValue').textContent = riskScore;
            console.log(`위험 점수 ${riskScore} → 경고 심각도 "${targetSeverity}"로 자동 조정`);
            isRiskScoreUpdating = false;
        }

        // 이벤트 리스너 등록
        document.getElementById('alertSeverity').addEventListener('change', onAlertSeverityChange);
        document.getElementById('riskScore').addEventListener('input', onRiskScoreChange);

        // 개별 체크박스 상태에 따라 전체 선택 체크박스 상태 업데이트
        function updateSelectAllCheckbox(categoryId, selectAllId) {
            const checkboxes = document.querySelectorAll(`#${categoryId} input[type="checkbox"]:not(#${selectAllId}):not(:disabled)`);
            const selectAllCheckbox = document.getElementById(selectAllId);

            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            const someChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);

            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;

            // 선택된 항목 수 업데이트
            const type = categoryId.replace('MetricCard', '');
            updateSelectedCount(type);
        }

        // 개별 체크박스에 이벤트 리스너 추가
        document.querySelectorAll('#timeMetricCard input[type="checkbox"]:not(#selectAllTime)').forEach(checkbox => {
            checkbox.addEventListener('change', () => updateSelectAllCheckbox('timeMetricCard', 'selectAllTime'));
        });

        document.querySelectorAll('#networkMetricCard input[type="checkbox"]:not(#selectAllNetwork)').forEach(checkbox => {
            checkbox.addEventListener('change', () => updateSelectAllCheckbox('networkMetricCard', 'selectAllNetwork'));
        });

        document.querySelectorAll('#accessMetricCard input[type="checkbox"]:not(#selectAllAccess)').forEach(checkbox => {
            checkbox.addEventListener('change', () => updateSelectAllCheckbox('accessMetricCard', 'selectAllAccess'));
        });

        // 로그 소스별 메트릭 가용성 매트릭스 (확장된 메트릭)
        const logSourceMetrics = {
            'windows': {
                'name': 'Windows 이벤트 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'session_duration', 'after_hours', 'weekend_activity', 'login_frequency', 'session_overlap', 'idle_time']
                },
                'network_based': {
                    'available': false,
                    'metrics': [],
                    'reason': 'Windows 이벤트 로그는 네트워크 정보를 포함하지 않습니다.'
                },
                'access_based': {
                    'available': true,
                    'metrics': ['resource_access', 'auth_failures', 'privilege_escalation', 'admin_access', 'app_usage', 'system_command', 'remote_access']
                }
            },
            'ad': {
                'name': 'Active Directory',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'session_duration', 'after_hours', 'weekend_activity', 'login_frequency', 'session_overlap']
                },
                'network_based': {
                    'available': false,
                    'metrics': [],
                    'reason': 'Active Directory는 네트워크 트래픽 정보를 제공하지 않습니다.'
                },
                'access_based': {
                    'available': true,
                    'metrics': ['resource_access', 'auth_failures', 'privilege_escalation', 'admin_access', 'app_usage', 'system_command', 'remote_access']
                }
            },
            'firewall': {
                'name': '방화벽 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'after_hours', 'weekend_activity', 'timezone_anomaly']
                },
                'network_based': {
                    'available': true,
                    'metrics': ['ip_address', 'geo_location', 'data_volume', 'impossible_travel', 'network_device', 'bandwidth_usage', 'connection_pattern']
                },
                'access_based': {
                    'available': false,
                    'metrics': [],
                    'reason': '방화벽 로그는 애플리케이션 수준의 접근 정보를 제공하지 않습니다.'
                }
            },
            'proxy': {
                'name': '프록시/웹 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'session_duration', 'after_hours', 'weekend_activity', 'login_frequency', 'timezone_anomaly']
                },
                'network_based': {
                    'available': true,
                    'metrics': ['ip_address', 'geo_location', 'data_volume', 'impossible_travel', 'network_device', 'bandwidth_usage', 'connection_pattern', 'proxy_bypass']
                },
                'access_based': {
                    'available': true,
                    'metrics': ['resource_access', 'auth_failures', 'file_download', 'app_usage', 'share_access']
                }
            },
            'vpn': {
                'name': 'VPN 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'session_duration', 'after_hours', 'weekend_activity', 'login_frequency', 'session_overlap', 'timezone_anomaly']
                },
                'network_based': {
                    'available': true,
                    'metrics': ['ip_address', 'geo_location', 'data_volume', 'impossible_travel', 'vpn_usage', 'network_device', 'bandwidth_usage', 'connection_pattern']
                },
                'access_based': {
                    'available': false,
                    'metrics': ['auth_failures'],
                    'reason': 'VPN 로그는 VPN 연결 정보만 제공하며, 내부 리소스 접근은 추적할 수 없습니다.'
                }
            },
            'dns': {
                'name': 'DNS 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'after_hours', 'weekend_activity', 'timezone_anomaly']
                },
                'network_based': {
                    'available': true,
                    'metrics': ['ip_address', 'geo_location', 'impossible_travel', 'connection_pattern']
                },
                'access_based': {
                    'available': false,
                    'metrics': [],
                    'reason': 'DNS 로그는 도메인 요청 정보만 제공하며, 인증이나 권한 정보는 포함하지 않습니다.'
                }
            },
            'email': {
                'name': '이메일 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'after_hours', 'weekend_activity', 'login_frequency', 'timezone_anomaly']
                },
                'network_based': {
                    'available': true,
                    'metrics': ['ip_address', 'data_volume', 'impossible_travel', 'network_device']
                },
                'access_based': {
                    'available': true,
                    'metrics': ['resource_access', 'auth_failures', 'sensitive_data', 'file_download', 'email_behavior']
                }
            },
            'linux': {
                'name': '리눅스/유닉스 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'session_duration', 'after_hours', 'weekend_activity', 'login_frequency', 'session_overlap', 'idle_time', 'timezone_anomaly']
                },
                'network_based': {
                    'available': true,
                    'metrics': ['ip_address', 'geo_location', 'impossible_travel', 'connection_pattern']
                },
                'access_based': {
                    'available': true,
                    'metrics': ['resource_access', 'auth_failures', 'privilege_escalation', 'admin_access', 'app_usage', 'system_command', 'remote_access']
                }
            },
            'database': {
                'name': '데이터베이스 로그',
                'time_based': {
                    'available': true,
                    'metrics': ['login_time', 'session_duration', 'after_hours', 'weekend_activity', 'login_frequency', 'idle_time']
                },
                'network_based': {
                    'available': false,
                    'metrics': [],
                    'reason': '데이터베이스 로그는 네트워크 수준 정보를 제공하지 않습니다.'
                },
                'access_based': {
                    'available': true,
                    'metrics': ['resource_access', 'auth_failures', 'privilege_escalation', 'sensitive_data', 'admin_access', 'db_query', 'system_command']
                }
            }
        };

        function updateProgressBar() {
            for (let i = 1; i <= totalSteps; i++) {
                const stepCircle = document.getElementById(`step${i}`);

                if (i < currentStep) {
                    stepCircle.className = 'step-circle completed';
                    stepCircle.innerHTML = '✓';
                } else if (i === currentStep) {
                    stepCircle.className = 'step-circle active';
                    stepCircle.innerHTML = i;
                } else {
                    stepCircle.className = 'step-circle inactive';
                    stepCircle.innerHTML = i;
                }
            }
        }

        function showStep(step) {
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`content${i}`).classList.remove('active');
            }

            document.getElementById(`content${step}`).classList.add('active');

            document.getElementById('prevBtn').disabled = step === 1;

            const nextBtn = document.getElementById('nextBtn');
            if (step === totalSteps) {
                nextBtn.innerHTML = '프로파일 생성 🚀';
                nextBtn.onclick = submitProfileForm;
            } else {
                nextBtn.innerHTML = '다음 →';
                nextBtn.onclick = nextStep;
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                    updateProgressBar();

                    if (currentStep === totalSteps) {
                        updateSummary();
                    }
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    const profileName = document.getElementById('profileName').value.trim();
                    if (!profileName) {
                        alert('프로파일 이름을 입력해주세요.');
                        return false;
                    }
                    return true;
                case 2:
                    const selectedLogSource = document.querySelector('input[name="logSource"]:checked');
                    if (!selectedLogSource) {
                        alert('로그 소스를 선택해주세요.');
                        return false;
                    }
                    return true;
                case 3:
                    const metrics = document.querySelectorAll('#content3 input[type="checkbox"]:checked:not(:disabled):not(#selectAllTime):not(#selectAllNetwork):not(#selectAllAccess)');
                    if (metrics.length === 0) {
                        alert('최소 하나의 분석 메트릭을 선택해주세요.');
                        return false;
                    }
                    return true;
                default:
                    return true;
            }
        }

        function updateMetricsBasedOnLogSource() {
            const selectedLogSource = document.querySelector('input[name="logSource"]:checked');
            if (!selectedLogSource) {
                disableAllMetrics();
                return;
            }

            const logType = selectedLogSource.value;
            const logConfig = logSourceMetrics[logType];

            const logInfo = document.getElementById('selectedLogInfo');
            const logSourceName = document.getElementById('logSourceName');
            const availableMetrics = document.getElementById('availableMetrics');

            logInfo.style.display = 'block';
            logSourceName.textContent = logConfig.name;

            const allAvailableMetrics = [];

            updateMetricCard('time', logConfig.time_based, allAvailableMetrics);
            updateMetricCard('network', logConfig.network_based, allAvailableMetrics);
            updateMetricCard('access', logConfig.access_based, allAvailableMetrics);

            availableMetrics.textContent = allAvailableMetrics.length > 0 ?
                allAvailableMetrics.join(', ') : '사용 가능한 메트릭이 없습니다';
        }

        // 메트릭 카드 업데이트 함수
        function updateMetricCard(type, config, allAvailableMetrics) {
            const cardId = type + 'MetricCard';
            const unavailableId = type + 'MetricUnavailable';
            const card = document.getElementById(cardId);
            const unavailableDiv = document.getElementById(unavailableId);
            const selectAllId = 'selectAll' + type.charAt(0).toUpperCase() + type.slice(1);
            const selectAllCheckbox = document.getElementById(selectAllId);
            const selectAllBtn = document.getElementById(selectAllId + 'Btn');

            if (config.available) {
                card.classList.remove('disabled');
                unavailableDiv.style.display = 'none';

                // 전체 선택 버튼 활성화
                selectAllBtn.disabled = false;
                selectAllBtn.style.opacity = '1';
                selectAllCheckbox.disabled = false;

                const checkboxes = card.querySelectorAll('input[type="checkbox"]:not(#' + selectAllId + ')');
                let enabledCount = 0;
                let checkedCount = 0;

                checkboxes.forEach(checkbox => {
                    const metricValue = checkbox.value;
                    if (config.metrics.includes(metricValue)) {
                        checkbox.disabled = false;
                        checkbox.parentElement.style.opacity = '1';
                        allAvailableMetrics.push(checkbox.nextElementSibling.textContent);
                        enabledCount++;
                        if (checkbox.checked) {
                            checkedCount++;
                        }
                    } else {
                        checkbox.disabled = true;
                        checkbox.checked = false;
                        checkbox.parentElement.style.opacity = '0.5';
                    }
                });

                // 전체 선택 체크박스 상태 업데이트
                if (enabledCount > 0) {
                    selectAllCheckbox.checked = (checkedCount === enabledCount);
                    selectAllCheckbox.indeterminate = (checkedCount > 0 && checkedCount < enabledCount);
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }

                // 선택된 항목 수 업데이트
                document.getElementById(type + 'SelectedCount').textContent = `${checkedCount}개 선택됨`;
            } else {
                card.classList.add('disabled');
                unavailableDiv.style.display = 'block';

                // 사유가 있으면 표시, 없으면 기본 메시지
                if (config.reason) {
                    unavailableDiv.textContent = config.reason;
                } else {
                    unavailableDiv.textContent = `이 로그 소스에서는 ${type} 기반 분석이 불가능합니다.`;
                }

                // 전체 선택 버튼 비활성화
                selectAllBtn.disabled = true;
                selectAllBtn.style.opacity = '0.5';
                selectAllCheckbox.disabled = true;
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;

                // 선택된 항목 수 초기화
                document.getElementById(type + 'SelectedCount').textContent = '0개 선택됨';

                const checkboxes = card.querySelectorAll('input[type="checkbox"]:not(#' + selectAllId + ')');
                checkboxes.forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                });
            }
        }

        function disableAllMetrics() {
            const logInfo = document.getElementById('selectedLogInfo');
            const availableMetrics = document.getElementById('availableMetrics');

            logInfo.style.display = 'none';
            availableMetrics.textContent = '-';

            // 모든 카드와 체크박스 비활성화
            const metricTypes = ['time', 'network', 'access'];

            metricTypes.forEach(type => {
                const cardId = type + 'MetricCard';
                const unavailableId = type + 'MetricUnavailable';
                const card = document.getElementById(cardId);
                const unavailableDiv = document.getElementById(unavailableId);
                const selectAllId = 'selectAll' + type.charAt(0).toUpperCase() + type.slice(1);
                const selectAllCheckbox = document.getElementById(selectAllId);
                const selectAllBtn = document.getElementById(selectAllId + 'Btn');

                card.classList.add('disabled');
                unavailableDiv.style.display = 'block';
                unavailableDiv.textContent = '로그 소스를 먼저 선택해주세요.';

                // 전체 선택 버튼 비활성화
                selectAllBtn.disabled = true;
                selectAllBtn.style.opacity = '0.5';
                selectAllCheckbox.disabled = true;
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;

                // 선택된 항목 수 초기화
                document.getElementById(type + 'SelectedCount').textContent = '0개 선택됨';

                const checkboxes = card.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                });
            });
        }

        function setupLogSourceListeners() {
            const radioButtons = document.querySelectorAll('input[name="logSource"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.radio-item').forEach(item => {
                        item.classList.remove('selected');
                    });

                    if (this.checked) {
                        this.closest('.radio-item').classList.add('selected');
                        updateMetricsBasedOnLogSource();
                    }
                });
            });

            // 라디오 아이템 클릭 시 라디오 버튼 선택
            document.querySelectorAll('.radio-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // 이미 라디오 버튼 자체를 클릭한 경우 중복 처리 방지
                    if (e.target.type === 'radio') return;

                    const radio = this.querySelector('input[type="radio"]');
                    if (radio && !radio.disabled) {
                        radio.checked = true;

                        // 선택 스타일 업데이트
                        document.querySelectorAll('.radio-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // 메트릭 업데이트
                        updateMetricsBasedOnLogSource();
                    }
                });
            });
        }

        function updateSummary() {
            document.getElementById('summaryName').textContent = document.getElementById('profileName').value || '-';
            document.getElementById('summaryType').textContent = document.getElementById('profileType').selectedOptions[0].textContent;
            document.getElementById('summaryScope').textContent = document.getElementById('analysisScope').selectedOptions[0].textContent;

            document.getElementById('summaryLearning').textContent = document.getElementById('learningPeriod').value + '일';

            const selectedLogSource = document.querySelector('input[name="logSource"]:checked');
            const sourcesContainer = document.getElementById('summaryDataSources');
            if (selectedLogSource) {
                const logConfig = logSourceMetrics[selectedLogSource.value];
                sourcesContainer.innerHTML = `<span class="tag">${logConfig.name}</span>`;
            } else {
                sourcesContainer.textContent = '선택된 소스가 없습니다';
            }

            // "전체 선택" 체크박스는 제외하고 선택된 메트릭만 가져오기
            const selectedMetrics = Array.from(document.querySelectorAll('#content3 input[type="checkbox"]:checked:not(:disabled):not(#selectAllTime):not(#selectAllNetwork):not(#selectAllAccess)'))
                .map(cb => cb.nextElementSibling.textContent);

            console.log('선택된 메트릭:', selectedMetrics); // 디버깅용

            const metricsContainer = document.getElementById('summaryMetrics');
            if (selectedMetrics.length > 0) {
                metricsContainer.innerHTML = selectedMetrics.map(metric => `<span class="tag">${metric}</span>`).join('');
            } else {
                metricsContainer.textContent = '선택된 메트릭이 없습니다';
            }

            document.getElementById('summarySensitivity').textContent = document.getElementById('anomalyThreshold').selectedOptions[0].textContent;
            document.getElementById('summaryRiskScore').textContent = document.getElementById('riskScore').value + '점';

            // 알림 설정 체크박스 명확하게 식별
            const selectedAlerts = Array.from(document.querySelectorAll('#content4 input[type="checkbox"]:checked'))
                .map(cb => cb.nextElementSibling.textContent);

            console.log('선택된 알림:', selectedAlerts); // 디버깅용

            const alertsContainer = document.getElementById('summaryAlerts');
            if (selectedAlerts.length > 0) {
                alertsContainer.innerHTML = selectedAlerts.map(alert => `<span class="tag">${alert}</span>`).join('');
            } else {
                alertsContainer.textContent = '알림 설정이 없습니다';
            }
        }

        // 프로필 생성 함수
        async function submitProfileForm() {
            const btn = document.getElementById('nextBtn');
            btn.disabled = true;
            btn.innerHTML = '생성 중... ⏳';

            try {
                // 프로필 데이터 수집
                const formData = {
                    name: document.getElementById('profileName').value,
                    description: document.getElementById('profileDescription').value,
                    profileType: document.getElementById('profileType').value,
                    analysisScope: document.getElementById('analysisScope').value,

                    // 로그 소스 정보
                    logSource: document.querySelector('input[name="logSource"]:checked')?.value,
                    logSourceName: document.querySelector('input[name="logSource"]:checked') ?
                        logSourceMetrics[document.querySelector('input[name="logSource"]:checked').value].name : null,
                    logSourceType: document.querySelector('input[name="logSource"]:checked')?.value,
                    learningPeriod: document.getElementById('learningPeriod').value,
                };

                // 추가 데이터는 data 필드에 저장
                const additionalData = {
                    // 분석 메트릭 - 체크된 항목들의 라벨 텍스트 수집 (전체 선택 체크박스 제외)
                    selectedMetrics: Array.from(document.querySelectorAll('#content3 input[type="checkbox"]:checked:not(:disabled):not(#selectAllTime):not(#selectAllNetwork):not(#selectAllAccess)'))
                        .map(cb => cb.nextElementSibling.textContent),

                    // 임계값 설정
                    anomalyThreshold: document.getElementById('anomalyThreshold').selectedOptions[0].textContent,
                    alertSeverity: document.getElementById('alertSeverity').value,
                    riskScore: Math.max(1, parseInt(document.getElementById('riskScore').value)), // 최소값 1 보장

                    // 알림 설정
                    alerts: Array.from(document.querySelectorAll('#content4 input[type="checkbox"]:checked'))
                        .map(cb => cb.nextElementSibling.textContent),
                };

                // 한글 메트릭을 영어로 변환하는 함수
                function translateMetricsToEnglish(koreanMetrics) {
                    const metricMap = {
                        // 시간 기반 메트릭 (8개)
                        '로그인 시간 패턴': 'login_time_pattern',
                        '세션 지속 시간': 'session_duration',
                        '유휴 시간 패턴': 'idle_time_pattern',
                        '비활성 시간 패턴': 'idle_time_pattern',
                        '업무시간 외 활동': 'after_hours_activity',
                        '주말/휴일 접근': 'weekend_holiday_access',
                        '로그인 빈도 변화': 'login_frequency_change',
                        '동시 세션 탐지': 'concurrent_session_detection',
                        '시간대 이상 접근': 'timezone_anomaly_access',

                        // 네트워크 기반 메트릭 (9개)
                        'IP 주소 패턴': 'ip_address_pattern',
                        '지리적 위치 분석': 'geo_location_analysis',
                        '데이터 전송량': 'data_volume_transfer',
                        '불가능한 이동 탐지': 'impossible_travel_detection',
                        'VPN 사용 패턴': 'vpn_usage_pattern',
                        '디바이스 변경 탐지': 'network_device_change',
                        '대역폭 사용량 이상': 'bandwidth_usage_anomaly',
                        '연결 패턴 분석': 'connection_pattern_analysis',
                        '프록시 우회 시도': 'proxy_bypass_attempt',

                        // 접근 기반 메트릭 (12개)
                        '리소스 접근 패턴': 'resource_access_pattern',
                        '인증 실패 횟수': 'authentication_failure_count',
                        '권한 상승 시도': 'privilege_escalation_attempt',
                        '민감한 데이터 접근': 'sensitive_data_access',
                        '민감 데이터 접근': 'sensitive_data_access',
                        '파일 다운로드 패턴': 'file_download_pattern',
                        '관리자 권한 사용': 'admin_privilege_usage',
                        '애플리케이션 사용 패턴': 'application_usage_pattern',
                        '데이터베이스 쿼리 패턴': 'database_query_pattern',
                        '이메일 행동 패턴': 'email_behavior_pattern',
                        '시스템 명령어 실행': 'system_command_execution',
                        '원격 접근 패턴': 'remote_access_pattern',
                        '공유 폴더 접근': 'shared_folder_access'
                    };

                    console.log('=== 메트릭 번역 디버깅 ===');
                    console.log('입력 메트릭 (한글):', koreanMetrics);

                    const translatedMetrics = koreanMetrics.map(koreanMetric => {
                        const englishMetric = metricMap[koreanMetric] || koreanMetric;
                        console.log(`번역: "${koreanMetric}" → "${englishMetric}"`);
                        return englishMetric;
                    });

                    console.log('번역된 메트릭 (영문):', translatedMetrics);
                    console.log('=====================');

                    return translatedMetrics;
                }

                // 분석 범위 매핑 함수 - 고정값
                function mapAnalysisScope(scope) {
                    const scopeMap = {
                        'department': 'department',
                        'role': 'user_activity',
                        'global': 'organizational'
                    };
                    return scopeMap[scope] || 'department';
                }

                // anomalyThreshold 텍스트를 alert_threshold 숫자로 변환 (서버와 일관된 기준값)
                function convertAnomalyThresholdToAlertThreshold(anomalyThreshold) {
                    const thresholdMap = {
                        '낮음 (관대함)': 0.9,     // 확실한 이상 징후만 알림
                        '낮음 (보수적)': 0.9,     // 호환성 유지
                        '보통 (권장)': 0.8,       // 균형 잡힌 탐지 (기본값)
                        '높음 (민감함)': 0.6      // 작은 변화도 민감하게 탐지
                    };
                    return thresholdMap[anomalyThreshold] || 0.8;
                }

                // 알림 설정을 notification_settings 형태로 변환
                function convertAlertsToNotificationSettings(alerts) {
                    return {
                        email_enabled: alerts.includes('이메일 알림'),
                        slack_enabled: alerts.includes('Slack 알림'),
                        sms_enabled: alerts.includes('SMS 알림'),
                        dashboard_enabled: alerts.includes('대시보드 표시')
                    };
                }

                // 베이스라인 엔진용 데이터 구조로 변환
                const translatedMetrics = translateMetricsToEnglish(additionalData.selectedMetrics);
                const mappedAnalysisScope = mapAnalysisScope(formData.analysisScope);
                const alertThreshold = convertAnomalyThresholdToAlertThreshold(additionalData.anomalyThreshold);
                const notificationSettings = convertAlertsToNotificationSettings(additionalData.alerts);

                // 베이스라인 엔진용 완전한 프로파일 데이터 구조
                const profileData = {
                    // 기본 정보
                    name: formData.name,
                    description: formData.description,
                    profile_type: formData.profileType,
                    analysis_scope: mappedAnalysisScope,
                    log_source: formData.logSourceType,
                    learning_period: parseInt(formData.learningPeriod),

                    // 메트릭 설정
                    selected_metrics: translatedMetrics,

                    // 임계값 설정
                    threshold_settings: {
                        alert_threshold: alertThreshold,
                        warning_threshold: alertThreshold - 0.2,
                        minimum_deviation_score: 0.3,
                        risk_score_threshold: Math.max(1, parseInt(additionalData.riskScore)) // 최소값 1 보장
                    },

                    // 알림 설정
                    notification_settings: notificationSettings,

                    // 로컬 DB용 추가 데이터 (호환성 유지)
                    id: currentEditProfile || generateUniqueId(),
                    profileType: formData.profileType,
                    analysisScope: formData.analysisScope,
                    logSourceName: formData.logSourceName,
                    logSourceType: formData.logSourceType,
                    learningPeriod: formData.learningPeriod,
                    ...additionalData
                };

                console.log('===== 완전한 프로파일 데이터 구조 =====');
                console.log('베이스라인 엔진용 데이터:', {
                    name: profileData.name,
                    description: profileData.description,
                    profile_type: profileData.profile_type,
                    analysis_scope: profileData.analysis_scope,
                    log_source: profileData.log_source,
                    learning_period: profileData.learning_period,
                    selected_metrics: profileData.selected_metrics,
                    threshold_settings: profileData.threshold_settings,
                    notification_settings: profileData.notification_settings
                });
                console.log('전체 프로파일 데이터:', profileData);
                console.log('=======================================');

                // 서버에 저장
                const saveResult = await saveProfile(profileData);
                console.log('프로필 저장 결과:', saveResult);

                if (saveResult) {
                    alert(`UBA 프로파일이 성공적으로 ${currentEditProfile ? '수정' : '생성'}되었습니다!\n\n시스템이 곧 학습을 시작할 예정입니다.`);
                    btn.innerHTML = '완료 ✅';

                    // 즉시 프로필 목록 검증
                    const allProfiles = await fetchProfiles();
                    console.log('저장 후 현재 프로필 목록:', allProfiles);
                    const savedProfile = allProfiles.find(p => p.id === profileData.id);
                    console.log('저장된 프로필 확인:', savedProfile);

                    // 페이지 이동 로직을 즉시 실행
                    if (isModalMode()) {
                        // 부모 창에 닫기 신호 전달
                        window.parent.closeWizardModal();
                    } else {
                        // 목록 페이지로 이동
                        window.location.href = 'index.html';
                    }
                } else {
                    alert('프로파일 저장 중 오류가 발생했습니다. 다시 시도해주세요.');
                    btn.disabled = false;
                    btn.innerHTML = '프로파일 생성 🚀';
                }
            } catch (error) {
                console.error('프로파일 생성 오류:', error);
                alert('프로파일 생성 중 오류가 발생했습니다: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '프로파일 생성 🚀';
            }
        }

        // 프로파일 저장 함수
        async function saveProfile(profileData) {
            try {
                // API를 통해 서버에 저장
                let result;
                if (currentEditProfile) {
                    // 기존 프로파일 업데이트
                    result = await updateProfile(currentEditProfile, profileData);
                } else {
                    // 새 프로파일 생성
                    if (!profileData.id) {
                        profileData.id = generateUniqueId();
                    }
                    result = await createProfile(profileData);
                }

                return !!result; // 저장 성공 여부 반환
            } catch (error) {
                console.error('프로파일 저장 오류:', error);
                return false;
            }
        }

        // 고유 ID 생성
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ID로 프로파일 가져오기
        async function getProfileById(id) {
            try {
                // API를 통해 서버에서 프로필 가져오기
                return await fetchProfileById(id);
            } catch (error) {
                console.error('프로필 조회 오류:', error);
                return null;
            }
        }

        // 편집할 프로파일 ID
        let currentEditProfile = null;

        // URL에서 편집 파라미터 확인
        async function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');

            if (editId) {
                currentEditProfile = editId;
                await loadProfileData(editId);
            }

            // 모달 모드인 경우 취소 버튼 동작 변경
            if (isModalMode()) {
                const cancelBtn = document.querySelector('.btn-secondary[style*="margin-right: auto"]');
                if (cancelBtn) {
                    cancelBtn.onclick = function() {
                        if (confirm('작업을 취소하시겠습니까?')) {
                            window.parent.closeWizardModal();
                        }
                    };
                }
            }
        }

        // 모달 모드인지 확인하는 함수
        function isModalMode() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('modal') === 'true';
        }

        // 프로파일 데이터 로드
        async function loadProfileData(profileId) {
            const profile = await getProfileById(profileId);
            if (!profile) {
                console.error('프로필을 찾을 수 없습니다:', profileId);
                return;
            }

            console.log('불러온 프로필 데이터:', profile);

            // 페이지 타이틀 업데이트
            document.querySelector('.header h1').textContent = 'UBA 프로파일 편집';
            document.querySelector('.header p').textContent = profile.name + ' 프로파일을 수정합니다';

            // 기본 정보 입력
            document.getElementById('profileName').value = profile.name;
            document.getElementById('profileDescription').value = profile.description || '';

            // 베이스라인 엔진 응답을 프론트엔드 형식으로 역변환 - 고정값
            function reverseMapAnalysisScope(engineScope) {
                const reverseMap = {
                    'department': 'department',         // 부서별 → 부서별
                    'user_activity': 'role',           // 사용자 활동 분석 → 역할별
                    'organizational': 'global',        // 조직 단위 분석 → 전체 조직
                    'network_access': 'role',          // 네트워크 접근 → 역할별
                    'comprehensive': 'global'          // 종합 분석 → 전체 조직
                };
                return reverseMap[engineScope] || 'department';
            }

            function reverseMapProfileType(engineType) {
                // 프로파일 유형은 베이스라인 엔진과 프론트엔드가 동일하지만,
                // 베이스라인 엔진에서 user → user, entity → entity로 그대로 매핑
                const reverseMap = {
                    'user': 'user',
                    'entity': 'entity',
                    'hybrid': 'hybrid'
                };
                return reverseMap[engineType] || 'user';
            }

            // 셀렉트 박스 값 설정 (역변환 적용)
            const frontendProfileType = reverseMapProfileType(profile.profile_type || profile.profileType);
            const frontendAnalysisScope = reverseMapAnalysisScope(profile.analysis_scope || profile.analysisScope);

            console.log('프로파일 유형/분석 범위 변환:', {
                engine_profile_type: profile.profile_type,
                frontend_profile_type: frontendProfileType,
                engine_analysis_scope: profile.analysis_scope,
                frontend_analysis_scope: frontendAnalysisScope
            });

            setSelectValue('profileType', frontendProfileType);
            setSelectValue('analysisScope', frontendAnalysisScope);

            // 학습 기간 설정 (베이스라인 엔진 데이터 우선 적용)
            const learningPeriod = profile.learning_period || profile.learningPeriod;
            console.log('학습 기간 설정:', {
                learning_period: profile.learning_period,
                learningPeriod: profile.learningPeriod,
                final: learningPeriod
            });
            setSelectValue('learningPeriod', learningPeriod);

            // 로그 소스 선택 (베이스라인 엔진의 log_source도 포함)
            const logSourceType = profile.log_source_type || profile.logSourceType || profile.log_source;
            console.log('로그 소스 타입:', logSourceType);
            console.log('프로파일 로그 관련 필드들:', {
                log_source: profile.log_source,
                log_source_type: profile.log_source_type,
                logSourceType: profile.logSourceType
            });

            if (logSourceType) {
                const logSourceRadio = document.querySelector(`input[name="logSource"][value="${logSourceType}"]`);
                if (logSourceRadio) {
                    logSourceRadio.checked = true;
                    logSourceRadio.closest('.radio-item').classList.add('selected');
                    updateMetricsBasedOnLogSource();

                    // 로그 소스 선택 후 충분한 시간이 지나야 메트릭 업데이트가 완료됨
                    await new Promise(resolve => setTimeout(resolve, 300));
                } else {
                    console.warn('로그 소스 라디오 버튼을 찾을 수 없습니다:', logSourceType);
                }
            }

            // 데이터 필드에서 추가 정보 추출
            const data = typeof profile.data === 'string' ? JSON.parse(profile.data || '{}') : (profile.data || {});
            console.log('데이터 필드:', data);

            // 3단계: 메트릭 설정
            // 메트릭 체크박스를 설정하기 전에 충분한 지연 시간을 줌
            await new Promise(resolve => setTimeout(resolve, 800));

            // 영어 메트릭을 한글로 변환하는 함수
            function translateMetricsToKorean(englishMetrics) {
                const metricMap = {
                    // 시간 기반 메트릭
                    'login_time_pattern': '로그인 시간 패턴',
                    'session_duration': '세션 지속 시간',
                    'after_hours_activity': '업무시간 외 활동',
                    'weekend_holiday_access': '주말/휴일 접근',
                    'login_frequency_change': '로그인 빈도 변화',
                    'concurrent_session_detection': '동시 세션 탐지',
                    'timezone_anomaly_access': '시간대 이상 접근',
                    'idle_time_pattern': '유휴 시간 패턴',

                    // 네트워크 기반 메트릭
                    'ip_address_pattern': 'IP 주소 패턴',
                    'geo_location_analysis': '지리적 위치 분석',
                    'data_volume_transfer': '데이터 전송량',
                    'impossible_travel_detection': '불가능한 이동 탐지',
                    'vpn_usage_pattern': 'VPN 사용 패턴',
                    'network_device_change': '디바이스 변경 탐지',
                    'bandwidth_usage_anomaly': '대역폭 사용량 이상',
                    'connection_pattern_analysis': '연결 패턴 분석',
                    'proxy_bypass_attempt': '프록시 우회 시도',

                    // 접근 기반 메트릭
                    'authentication_failure_count': '인증 실패 횟수',
                    'privilege_escalation_attempt': '권한 상승 시도',
                    'remote_access_pattern': '원격 접근 패턴',
                    'resource_access_pattern': '리소스 접근 패턴',
                    'sensitive_data_access': '민감한 데이터 접근',
                    'file_download_pattern': '파일 다운로드 패턴',
                    'admin_privilege_usage': '관리자 권한 사용',
                    'application_usage_pattern': '애플리케이션 사용 패턴',
                    'system_command_execution': '시스템 명령어 실행',
                    'database_query_pattern': '데이터베이스 쿼리 패턴',
                    'email_behavior_pattern': '이메일 행동 패턴',
                    'shared_folder_access': '공유 폴더 접근'
                };

                return englishMetrics.map(englishMetric =>
                    metricMap[englishMetric] || englishMetric
                );
            }

            // 선택된 메트릭 정보를 여러 가능한 소스에서 찾음
            let selectedMetrics = [];

            // data 객체 안에 있을 수 있는 여러 형태의 메트릭 데이터 확인
            if (Array.isArray(data.selectedMetrics)) {
                selectedMetrics = data.selectedMetrics;
            } else if (Array.isArray(profile.selectedMetrics)) {
                selectedMetrics = profile.selectedMetrics;
            } else if (Array.isArray(profile.selected_metrics)) {
                // 베이스라인 엔진 응답 (영어 메트릭) - 한글로 변환
                selectedMetrics = translateMetricsToKorean(profile.selected_metrics);
                console.log('베이스라인 엔진 메트릭 변환:', {
                    original: profile.selected_metrics,
                    translated: selectedMetrics
                });
            } else if (data.metrics && Array.isArray(data.metrics)) {
                selectedMetrics = data.metrics;
            } else if (profile.metrics && Array.isArray(profile.metrics)) {
                selectedMetrics = profile.metrics;
            }

            console.log('적용할 선택된 메트릭:', selectedMetrics);

            // 메트릭 체크박스 설정
            if (selectedMetrics.length > 0) {
                const metricCheckboxes = document.querySelectorAll('#content3 input[type="checkbox"]:not(#selectAllTime):not(#selectAllNetwork):not(#selectAllAccess)');

                metricCheckboxes.forEach(checkbox => {
                    const metricLabel = checkbox.nextElementSibling.textContent.trim();
                    const isSelected = selectedMetrics.some(metric =>
                        metric === metricLabel ||
                        metric.includes(metricLabel) ||
                        metricLabel.includes(metric)
                    );

                    if (isSelected && !checkbox.disabled) {
                        checkbox.checked = true;
                        console.log('메트릭 체크됨:', metricLabel);
                    }
                });

                // 각 카테고리별 전체 선택 체크박스 상태 업데이트
                updateSelectAllCheckbox('timeMetricCard', 'selectAllTime');
                updateSelectAllCheckbox('networkMetricCard', 'selectAllNetwork');
                updateSelectAllCheckbox('accessMetricCard', 'selectAllAccess');

                // 선택된 메트릭 수 업데이트
                updateSelectedCount('time');
                updateSelectedCount('network');
                updateSelectedCount('access');
            }

            // 4단계: 임계값 설정
            // 베이스라인 엔진의 threshold_settings를 프론트엔드 형식으로 변환
            function convertThresholdSettingsToFrontend(thresholdSettings) {
                if (!thresholdSettings) return {};

                // alert_threshold 값을 anomalyThreshold 텍스트로 변환 - 서버와 일관된 기준값
                let anomalyThreshold = 'medium';
                if (thresholdSettings.alert_threshold >= 0.9) {
                    anomalyThreshold = 'low';      // 낮음 (관대함) - alert_threshold 0.9
                } else if (thresholdSettings.alert_threshold >= 0.8) {
                    anomalyThreshold = 'medium';   // 보통 (권장) - alert_threshold 0.8
                } else if (thresholdSettings.alert_threshold >= 0.6) {
                    anomalyThreshold = 'high';     // 높음 (민감함) - alert_threshold 0.6
                } else {
                    anomalyThreshold = 'medium';   // 기본값
                }

                console.log('convertThresholdSettingsToFrontend - anomalyThreshold 변환 (고정값):', {
                    alert_threshold: thresholdSettings.alert_threshold,
                    converted_anomalyThreshold: anomalyThreshold
                });

                // risk_score_threshold를 alertSeverity로 변환 (getRiskScoreToSeverity와 일치)
                let alertSeverity = 'medium';
                const riskScore = thresholdSettings.risk_score_threshold || 1;
                alertSeverity = getRiskScoreToSeverity(riskScore);

                const result = {
                    anomalyThreshold: anomalyThreshold,
                    alertSeverity: alertSeverity,
                    riskScore: thresholdSettings.risk_score_threshold || 70
                };

                console.log('convertThresholdSettingsToFrontend 최종 결과:', result);
                return result;
            }

            // 베이스라인 엔진의 threshold_settings 처리
            let frontendThresholdData = {};
            if (profile.threshold_settings) {
                frontendThresholdData = convertThresholdSettingsToFrontend(profile.threshold_settings);
                console.log('베이스라인 엔진 threshold_settings 변환:', {
                    original: profile.threshold_settings,
                    converted: frontendThresholdData
                });
            }

            // anomalyThreshold 설정 - 베이스라인 엔진 데이터 우선 적용
            console.log('anomalyThreshold 설정 디버깅:', {
                frontendThresholdData_anomalyThreshold: frontendThresholdData.anomalyThreshold,
                data_anomalyThreshold: data.anomalyThreshold,
                profile_anomalyThreshold: profile.anomalyThreshold
            });

            const anomalyThreshold = frontendThresholdData.anomalyThreshold || data.anomalyThreshold || profile.anomalyThreshold;
            console.log('최종 anomalyThreshold 값:', anomalyThreshold);

            if (anomalyThreshold) {
                if (['low', 'medium', 'high'].includes(anomalyThreshold)) {
                    setSelectValue('anomalyThreshold', anomalyThreshold);
                    console.log('anomalyThreshold 설정 완료:', anomalyThreshold);
                } else {
                    // 텍스트 값으로 검색
                    const matchingOption = getKeyByText('anomalyThreshold', anomalyThreshold);
                    if (matchingOption) {
                        setSelectValue('anomalyThreshold', matchingOption);
                        console.log('텍스트 매칭으로 anomalyThreshold 설정:', matchingOption);
                    } else {
                        console.warn('적절한 anomalyThreshold 값을 찾을 수 없습니다:', anomalyThreshold);
                    }
                }
            } else {
                console.warn('anomalyThreshold 값이 없습니다');
            }

            // alertSeverity 설정 - 베이스라인 엔진 데이터 우선 적용
            const alertSeverity = frontendThresholdData.alertSeverity || data.alertSeverity || profile.alertSeverity || 'medium';
            setSelectValue('alertSeverity', alertSeverity);

            // 위험 점수 설정 - 베이스라인 엔진 데이터 우선 적용 (0일 때 1로 변환)
            const hasRiskScore = frontendThresholdData.riskScore !== undefined && frontendThresholdData.riskScore !== null;

            if (hasRiskScore) {
                // 베이스라인 엔진에서 온 위험 점수 사용 (0이면 1로 변환)
                let riskScore = frontendThresholdData.riskScore;
                if (riskScore === 0) {
                    riskScore = 1;
                    console.log('위험 점수 0을 1로 변환');
                }
                document.getElementById('riskScore').value = riskScore;
                document.getElementById('riskScoreValue').textContent = riskScore;

                // 위험 점수에 맞는 심각도로 동기화
                const syncedSeverity = getRiskScoreToSeverity(riskScore);
                if (document.getElementById('alertSeverity').value !== syncedSeverity) {
                    console.log('위험 점수 기준 심각도 동기화:', {
                        riskScore: riskScore,
                        syncedSeverity: syncedSeverity,
                        currentSeverity: document.getElementById('alertSeverity').value
                    });
                    setSelectValue('alertSeverity', syncedSeverity);
                }
            } else {
                // 베이스라인 엔진 데이터가 없으면 심각도에 맞는 위험 점수로 동기화
                if (alertSeverity && severityRiskScoreMapping[alertSeverity]) {
                    const syncedRiskScore = severityRiskScoreMapping[alertSeverity];
                    document.getElementById('riskScore').value = syncedRiskScore;
                    document.getElementById('riskScoreValue').textContent = syncedRiskScore;
                    console.log('심각도 기준 위험 점수 동기화:', {
                        alertSeverity: alertSeverity,
                        syncedRiskScore: syncedRiskScore
                    });
                }
            }

            // 알림 설정 체크박스 설정
            let alerts = data.alerts || profile.alerts || [];

            // 베이스라인 엔진의 notification_settings 처리
            if (alerts.length === 0 && profile.notification_settings) {
                const notificationSettings = profile.notification_settings;
                console.log('베이스라인 엔진 notification_settings:', notificationSettings);

                alerts = [];
                if (notificationSettings.email_enabled) alerts.push('이메일 알림');
                if (notificationSettings.slack_enabled) alerts.push('Slack 알림');
                if (notificationSettings.sms_enabled) alerts.push('SMS 알림');
                if (notificationSettings.dashboard_enabled) alerts.push('대시보드 표시');

                console.log('변환된 알림 설정:', alerts);
            }

            console.log('최종 알림 설정:', alerts);

            // 알림 체크박스 설정 - 구체적인 ID로 설정
            if (alerts.length > 0) {
                // 먼저 모든 체크박스를 초기화
                document.getElementById('emailAlert').checked = false;
                document.getElementById('slackAlert').checked = false;
                document.getElementById('smsAlert').checked = false;
                document.getElementById('dashboardAlert').checked = false;

                // 설정된 알림만 체크
                alerts.forEach(alert => {
                    console.log('알림 설정 처리 중:', alert);
                    if (alert === '이메일 알림') {
                        document.getElementById('emailAlert').checked = true;
                        console.log('이메일 알림 체크됨');
                    } else if (alert === 'Slack 알림') {
                        document.getElementById('slackAlert').checked = true;
                        console.log('Slack 알림 체크됨');
                    } else if (alert === 'SMS 알림') {
                        document.getElementById('smsAlert').checked = true;
                        console.log('SMS 알림 체크됨');
                    } else if (alert === '대시보드 표시') {
                        document.getElementById('dashboardAlert').checked = true;
                        console.log('대시보드 표시 체크됨');
                    }
                });
            } else {
                // 기본값으로 이메일과 대시보드 알림 활성화
                document.getElementById('emailAlert').checked = true;
                document.getElementById('dashboardAlert').checked = true;
                console.log('기본 알림 설정 적용됨');
            }

            // 체크박스 상태 확인
            console.log('알림 체크박스 최종 상태:', {
                email: document.getElementById('emailAlert').checked,
                slack: document.getElementById('slackAlert').checked,
                sms: document.getElementById('smsAlert').checked,
                dashboard: document.getElementById('dashboardAlert').checked
            });

            // 5단계: 요약 정보 업데이트
            if (currentStep === totalSteps) {
                updateSummary();
            }
        }

        // 셀렉트 박스 값 설정 헬퍼 함수
        function setSelectValue(selectId, value) {
            const select = document.getElementById(selectId);
            if (select && value !== null && value !== undefined) {
                const stringValue = String(value); // 숫자든 문자열이든 문자열로 변환
                console.log(`setSelectValue: ${selectId} = ${value} (${typeof value}) -> "${stringValue}"`);

                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === stringValue) {
                        select.selectedIndex = i;
                        console.log(`${selectId} 값이 ${stringValue}로 설정됨`);
                        break;
                    }
                }
            }
        }

        // 텍스트로 셀렉트 박스 값 찾기
        function getKeyByText(selectId, text) {
            const select = document.getElementById(selectId);
            if (select && text) {
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].textContent === text ||
                        select.options[i].textContent.includes(text) ||
                        text.includes(select.options[i].textContent)) {
                        return select.options[i].value;
                    }
                }
            }
            return null;
        }

        function resetWizard() {
            currentStep = 1;
            showStep(currentStep);
            updateProgressBar();

            document.getElementById('profileName').value = '';
            document.getElementById('profileDescription').value = '';
            document.getElementById('profileType').selectedIndex = 0;
            document.getElementById('analysisScope').selectedIndex = 0;
            document.getElementById('learningPeriod').selectedIndex = 2;
            document.getElementById('anomalyThreshold').selectedIndex = 1;
            document.getElementById('alertSeverity').selectedIndex = 2;
            document.getElementById('riskScore').value = 70;
            document.getElementById('riskScoreValue').textContent = '70';

            const radioButtons = document.querySelectorAll('input[name="logSource"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
                radio.closest('.radio-item').classList.remove('selected');
            });

            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.disabled = false;
            });

            document.getElementById('emailAlert').checked = true;
            document.getElementById('dashboardAlert').checked = true;

            disableAllMetrics();

            // 편집 모드 초기화
            currentEditProfile = null;

            // 페이지 타이틀 복원
            document.querySelector('.header h1').textContent = 'UBA 프로파일 마법사';
            document.querySelector('.header p').textContent = '사용자 및 엔터티 행동 분석 프로파일을 쉽게 설정하세요';
        }

        // 위험 점수 슬라이더 업데이트
        document.getElementById('riskScore').addEventListener('input', function() {
            document.getElementById('riskScoreValue').textContent = this.value;
        });

        // 스텝 이동 시 요약 정보 업데이트
        function nextStep() {
            if (currentStep < totalSteps) {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                    updateProgressBar();

                    if (currentStep === totalSteps) {
                        updateSummary();
                    }
                }
            }
        }

        // 초기화
        updateProgressBar();
        showStep(currentStep);

        // 비동기 초기화 함수
        async function initializeWizard() {
            setupLogSourceListeners();
            disableAllMetrics();
            await checkEditMode(); // 편집 모드 확인 (비동기)
        }

        // 초기화 실행
        setTimeout(() => {
            initializeWizard();
        }, 100);

        // 취소 버튼 추가
        const buttonGroup = document.querySelector('.button-group');
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.textContent = '취소';
        cancelBtn.style.marginRight = 'auto';
        cancelBtn.onclick = function() {
            if (confirm('작업을 취소하고 목록으로 돌아가시겠습니까?')) {
                // 모달 모드인지 확인
                if (isModalMode()) {
                    window.parent.closeWizardModal();
                } else {
                    window.location.href = 'index.html';
                }
            }
        };

        // prevBtn 앞에 취소 버튼 삽입
        buttonGroup.insertBefore(cancelBtn, document.getElementById('prevBtn'));
    </script>
</body>
</html>
