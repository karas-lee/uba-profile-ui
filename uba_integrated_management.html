<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBA 프로파일 통합 관리</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header .back-button {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) translateX(-2px);
        }

        .header-content {
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        /* 프로파일 관리 섹션 */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        /* 프로파일 테이블 */
        .profile-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .profile-table th {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 15px 12px;
            font-weight: 600;
            text-align: left;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            font-size: 14px;
        }

        .profile-table tr:hover {
            background: #f8f9fa;
        }

        .profile-table tr:last-child td {
            border-bottom: none;
        }

        /* 상태 배지 */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .status-running {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        /* 액션 버튼 */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn.manual-run {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .action-btn.edit {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .action-btn.delete {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .action-btn.view {
            background: linear-gradient(135deg, #6f42c1, #59359a);
            color: white;
        }

        /* 로딩 스피너 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 체크박스 스타일 */
        .profile-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* 토스트 메시지 */
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast-message.show {
            transform: translateX(0);
        }

        .toast-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .toast-error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .toast-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .toast-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #6c757d;
            font-weight: 500;
        }

        /* 실행 이력 테이블 */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .history-table th {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 15px 12px;
            font-weight: 600;
            text-align: left;
            font-size: 14px;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .tab-content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .profile-table, .history-table {
                font-size: 12px;
            }

            .profile-table th, .profile-table td,
            .history-table th, .history-table td {
                padding: 8px 6px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 4px;
            }

            .action-btn {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <a href="index.html" class="back-button">
                <span>🔙</span>
                대시보드로 돌아가기
            </a>
            <div class="header-content">
                <h1>🛡️ UBA 프로파일 통합 관리</h1>
                <p>사용자 행동 분석 프로파일 및 베이스라인 통합 관리 시스템</p>
            </div>
        </div>

        <!-- 내비게이션 탭 -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('profile-management')">프로파일 실행 관리</button>
            <button class="nav-tab" onclick="showTab('execution-history')">실행 이력</button>
            <button class="nav-tab" onclick="showTab('monitoring')">모니터링</button>
        </div>

        <!-- 프로파일 실행 관리 탭 -->
        <div id="profile-management" class="tab-content active">
            <div class="section-header">
                <h2 class="section-title">프로파일 실행 관리</h2>
                <div class="button-group">
                    <button class="btn btn-success" id="manualRunBtn">수동 베이스라인 생성</button>
                    <button class="btn btn-warning" id="manualRunSelectedBtn">선택 항목 수동 베이스라인 생성</button>
                    <button class="btn btn-primary" onclick="refreshProfiles()">새로고침</button>
                </div>
            </div>

            <!-- 통계 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalProfiles">0</div>
                    <div class="stat-label">전체 프로파일</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeProfiles">0</div>
                    <div class="stat-label">활성 프로파일</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="runningBaselines">0</div>
                    <div class="stat-label">실행 중인 베이스라인</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedToday">0</div>
                    <div class="stat-label">오늘 완료된 작업</div>
                </div>
            </div>

            <!-- 프로파일 목록 -->
            <div id="profileTableContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    프로파일 목록을 불러오는 중...
                </div>
            </div>
        </div>

        <!-- 실행 이력 탭 -->
        <div id="execution-history" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">베이스라인 실행 이력</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="refreshHistory()" title="베이스라인 엔진에서 실행 이력을 조회합니다">새로고침</button>
                    <button class="btn btn-success" onclick="exportHistory()">이력 내보내기</button>
                </div>
            </div>

            <!-- 실행 이력 목록 -->
            <div id="historyTableContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    실행 이력을 불러오는 중...
                </div>
            </div>
        </div>

        <!-- 모니터링 탭 -->
        <div id="monitoring" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">시스템 모니터링</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="refreshMonitoring()">새로고침</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="systemStatus">정상</div>
                    <div class="stat-label">시스템 상태</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="baselineEngineStatus">연결됨</div>
                    <div class="stat-label">베이스라인 엔진</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastSync">방금 전</div>
                    <div class="stat-label">마지막 동기화</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorCount">0</div>
                    <div class="stat-label">오류 수</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let profiles = [];
        let executionHistory = [];
        let selectedProfiles = [];

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('UBA 통합 관리 시스템 초기화 시작');

            // 이벤트 리스너 설정
            setupEventListeners();

            // 초기 데이터 로드
            await refreshProfiles();
            await refreshMonitoring();

            // 베이스라인 엔진 전용 모드에서는 실행 이력을 기본적으로 로드하지 않음
            // 사용자가 명시적으로 새로고침 버튼을 클릭할 때만 시도

            console.log('초기화 완료');
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            const manualRunBtn = document.getElementById('manualRunBtn');
            const manualRunSelectedBtn = document.getElementById('manualRunSelectedBtn');

            if (manualRunBtn) {
                manualRunBtn.addEventListener('click', runManualBaselineForAll);
            }

            if (manualRunSelectedBtn) {
                manualRunSelectedBtn.addEventListener('click', runManualBaselineForSelected);
            }
        }

        // 탭 전환
        function showTab(tabName) {
            // 모든 탭 숨기기
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));

            // 모든 탭 버튼 비활성화
            const tabButtons = document.querySelectorAll('.nav-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));

            // 선택된 탭 표시
            const selectedTab = document.getElementById(tabName);
            const selectedButton = event.target;

            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // 탭별 데이터 새로고침
            if (tabName === 'profile-management') {
                refreshProfiles();
            } else if (tabName === 'execution-history') {
                // 실행 이력 탭 활성화 시 자동으로 이력 로드
                console.log('실행 이력 탭 활성화 - 베이스라인 엔진에서 이력 조회 시작');
                refreshHistory();
            } else if (tabName === 'monitoring') {
                refreshMonitoring();
            }
        }

        // 프로파일 목록 새로고침 (베이스라인 API에서 직접 조회)
        async function refreshProfiles() {
            try {
                console.log('프로파일 목록 새로고침 시작');
                showLoading('profileTableContainer', '프로파일 목록을 불러오는 중...');

                // 프록시를 통해 베이스라인 엔진 API 호출 (CORS 문제 해결)
                const response = await fetch('/api/profiles');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('프로파일 데이터:', data);

                // 응답 데이터 구조 처리
                if (data.profiles && Array.isArray(data.profiles)) {
                    profiles = data.profiles;
                } else if (Array.isArray(data)) {
                    profiles = data;
                } else {
                    throw new Error('프로파일 데이터 형식이 올바르지 않습니다.');
                }

                // 각 프로파일의 베이스라인 상태 조회
                await loadProfileBaselineStatuses();

                // 프로파일 테이블 렌더링
                renderProfileTable();

                // 통계 업데이트
                updateProfileStats();

                console.log(`${profiles.length}개의 프로파일을 로드했습니다.`);

            } catch (error) {
                console.error('프로파일 목록 새로고침 실패:', error);
                showError('profileTableContainer', '프로파일 목록을 불러오는데 실패했습니다: ' + error.message);
                showToast('프로파일 목록 새로고침 실패: ' + error.message, 'error');
            }
        }

        // 프로파일별 베이스라인 상태 조회
        async function loadProfileBaselineStatuses() {
            for (let profile of profiles) {
                try {
                    const response = await fetch(`/api/profiles/${profile.id}/baseline/status`);
                    if (response.ok) {
                        const statusData = await response.json();
                        profile.baseline_status = statusData;
                    }
                } catch (error) {
                    console.warn(`프로파일 ${profile.id} 베이스라인 상태 조회 실패:`, error.message);
                    profile.baseline_status = null;
                }
            }
        }

        // 프로파일 테이블 렌더링
        function renderProfileTable() {
            const container = document.getElementById('profileTableContainer');

            if (!profiles || profiles.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>등록된 프로파일이 없습니다</h3>
                        <p>프로파일 마법사를 통해 새 프로파일을 생성해보세요.</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="profile-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>프로파일명</th>
                            <th>타입</th>
                            <th>로그 소스</th>
                            <th>학습 기간</th>
                            <th>상태</th>
                            <th>베이스라인 상태</th>
                            <th>마지막 업데이트</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            profiles.forEach(profile => {
                const baselineStatus = getBaselineStatusDisplay(profile.baseline_status);
                const formattedDate = formatDate(profile.updated_at);

                tableHTML += `
                    <tr>
                        <td>
                            <input type="checkbox" class="profile-checkbox"
                                   data-id="${profile.id}"
                                   onchange="updateSelectedProfiles()">
                        </td>
                        <td>
                            <strong>${escapeHtml(profile.name)}</strong>
                            <br><small style="color: #6c757d;">${escapeHtml(profile.description || '')}</small>
                        </td>
                        <td>
                            <span class="status-badge ${getProfileTypeClass(profile.profile_type)}">
                                ${getProfileTypeText(profile.profile_type)}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${getLogSourceClass(profile.log_source)}">
                                ${getLogSourceText(profile.log_source)}
                            </span>
                        </td>
                        <td>${profile.learning_period}일</td>
                        <td>
                            <span class="status-badge ${profile.status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${profile.status === 'active' ? '활성' : '비활성'}
                            </span>
                        </td>
                        <td>${baselineStatus}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn manual-run"
                                        title="수동 베이스라인 생성"
                                        onclick="runManualBaseline('${profile.id}')">
                                    <span>🔧</span>
                                </button>
                                <button class="action-btn view"
                                        title="상세 보기"
                                        onclick="viewProfile('${profile.id}')">
                                    <span>👁️</span>
                                </button>
                                <button class="action-btn edit"
                                        title="편집"
                                        onclick="editProfile('${profile.id}')">
                                    <span>✏️</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // 베이스라인 상태 표시 생성
        function getBaselineStatusDisplay(baselineStatus) {
            if (!baselineStatus) {
                return '<span class="status-badge status-inactive">알 수 없음</span>';
            }

            // 최신 작업 상태가 있는 경우 우선적으로 사용
            if (baselineStatus.latest_job && baselineStatus.latest_job.status) {
                const jobStatus = baselineStatus.latest_job.status;
                const statusClass = getBaselineStatusClass(jobStatus);
                const statusText = getBaselineStatusText(jobStatus);
                return `<span class="status-badge ${statusClass}">${statusText}</span>`;
            }

            // 베이스라인이 존재하는지 확인
            if (baselineStatus.baseline_count && baselineStatus.baseline_count > 0) {
                return '<span class="status-badge status-completed">완료</span>';
            }

            // 베이스라인이 없는 경우
            return '<span class="status-badge status-inactive">없음</span>';
        }

        // 베이스라인 상태 클래스 매핑
        function getBaselineStatusClass(status) {
            const statusMap = {
                'success': 'status-completed',      // 베이스라인 엔진에서 반환하는 성공 상태
                'completed': 'status-completed',
                'in_progress': 'status-running',
                'running': 'status-running',        // 실행 중 상태
                'failed': 'status-failed',
                'error': 'status-failed',           // 오류 상태
                'pending': 'status-inactive'
            };
            return statusMap[status] || 'status-inactive';
        }

        // 베이스라인 상태 텍스트 매핑
        function getBaselineStatusText(status) {
            const statusMap = {
                'success': '완료',                  // 베이스라인 엔진에서 반환하는 성공 상태
                'completed': '완료',
                'in_progress': '진행중',
                'running': '진행중',                // 실행 중 상태
                'failed': '실패',
                'error': '실패',                    // 오류 상태
                'pending': '대기중'
            };
            return statusMap[status] || '알 수 없음';
        }

        // 프로파일 타입 클래스 매핑
        function getProfileTypeClass(type) {
            const typeMap = {
                'user': 'status-active',
                'hybrid': 'status-running',
                'group': 'status-inactive'
            };
            return typeMap[type] || 'status-inactive';
        }

        // 프로파일 타입 텍스트 매핑
        function getProfileTypeText(type) {
            const typeMap = {
                'user': '사용자',
                'hybrid': '하이브리드',
                'group': '그룹'
            };
            return typeMap[type] || type;
        }

        // 로그 소스 클래스 매핑
        function getLogSourceClass(source) {
            return 'status-active';
        }

        // 로그 소스 텍스트 매핑
        function getLogSourceText(source) {
            const sourceMap = {
                'vpn': 'VPN',
                'proxy': '프록시',
                'database': '데이터베이스',
                'application': '애플리케이션',
                'system': '시스템'
            };
            return sourceMap[source] || source;
        }

        // 실행 이력 새로고침 (베이스라인 엔진 전용)
        async function refreshHistory() {
            try {
                console.log('베이스라인 엔진 실행 이력 조회 시도');
                showLoading('historyTableContainer', '베이스라인 엔진에서 실행 이력을 조회하는 중...');

                // 베이스라인 엔진 API 호출
                const response = await fetch('/api/profiles/baseline/history?limit=100');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('베이스라인 엔진 실행 이력 응답:', data);

                if (data.success === false) {
                    // 베이스라인 엔진에서 실행 이력을 제공하지 않는 경우
                    const container = document.getElementById('historyTableContainer');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <h3>실행 이력 조회 불가</h3>
                            <p>${data.message || '베이스라인 엔진에서 실행 이력을 제공하지 않습니다.'}</p>
                            <p><small>${data.details || ''}</small></p>
                            <p><strong>제안:</strong> ${data.suggestion || '프로파일 목록에서 개별 프로파일의 상태를 확인하세요.'}</p>
                        </div>
                    `;
                    return;
                }

                // 응답 데이터 구조 처리
                if (data.history && Array.isArray(data.history)) {
                    executionHistory = data.history;
                } else if (Array.isArray(data)) {
                    executionHistory = data;
                } else {
                    executionHistory = [];
                }

                // 실행 이력 테이블 렌더링
                renderHistoryTable();

                console.log(`${executionHistory.length}개의 실행 이력을 로드했습니다.`);

            } catch (error) {
                console.error('베이스라인 엔진 실행 이력 조회 실패:', error);
                const container = document.getElementById('historyTableContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>실행 이력 조회 실패</h3>
                        <p>베이스라인 엔진에서 실행 이력을 조회할 수 없습니다.</p>
                        <p><small>${error.message}</small></p>
                        <p><strong>안내:</strong> 베이스라인 생성 작업은 백그라운드에서 진행되며, 개별 프로파일 상태는 프로파일 목록에서 확인하실 수 있습니다.</p>
                    </div>
                `;
            }
        }

        // 실행 이력 테이블 렌더링
        function renderHistoryTable() {
            const container = document.getElementById('historyTableContainer');

            if (!executionHistory || executionHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>실행 이력이 없습니다</h3>
                        <p>베이스라인 생성 작업을 실행하면 이력이 표시됩니다.</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>작업 ID</th>
                            <th>프로파일</th>
                            <th>상태</th>
                            <th>진행률</th>
                            <th>메시지</th>
                            <th>시작 시간</th>
                            <th>완료 시간</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            executionHistory.forEach(history => {
                const startTime = formatDate(history.created_at);
                const completedTime = history.completed_at ? formatDate(history.completed_at) : '-';
                const progress = history.progress_percentage || 0;

                tableHTML += `
                    <tr>
                        <td>
                            <code style="font-size: 12px; background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">
                                ${escapeHtml(history.job_id)}
                            </code>
                        </td>
                        <td>
                            <strong>${escapeHtml(history.profile_name || history.profile_id)}</strong>
                            <br><small style="color: #6c757d;">${escapeHtml(history.profile_id)}</small>
                        </td>
                        <td>
                            <span class="status-badge ${getBaselineStatusClass(history.status)}">
                                ${getBaselineStatusText(history.status)}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <div style="background: #e9ecef; height: 8px; width: 60px; border-radius: 4px; margin-right: 8px;">
                                    <div style="background: #007bff; height: 100%; width: ${progress}%; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 12px;">${progress}%</span>
                            </div>
                        </td>
                        <td>
                            <small style="color: #6c757d;">
                                ${escapeHtml(history.message || '메시지 없음')}
                            </small>
                        </td>
                        <td>${startTime}</td>
                        <td>${completedTime}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // 모니터링 새로고침
        async function refreshMonitoring() {
            try {
                console.log('모니터링 정보 새로고침');

                // 베이스라인 엔진 상태 확인
                const healthResponse = await fetch('/api/profiles').catch(() => null);
                const isHealthy = healthResponse && healthResponse.ok;

                document.getElementById('systemStatus').textContent = '정상';
                document.getElementById('baselineEngineStatus').textContent = isHealthy ? '연결됨' : '연결 실패';
                document.getElementById('lastSync').textContent = '방금 전';
                document.getElementById('errorCount').textContent = '0';

            } catch (error) {
                console.error('모니터링 새로고침 실패:', error);
                document.getElementById('systemStatus').textContent = '오류';
                document.getElementById('baselineEngineStatus').textContent = '연결 실패';
            }
        }

        // 프로파일 통계 업데이트 (베이스라인 엔진 전용)
        function updateProfileStats() {
            const total = profiles.length;
            const active = profiles.filter(p => p.status === 'active').length;
            const running = profiles.filter(p =>
                p.baseline_status &&
                p.baseline_status.latest_baseline &&
                p.baseline_status.latest_baseline.status === 'in_progress'
            ).length;

            // 베이스라인 엔진에서 실행 이력을 조회할 수 없으므로 기본값 사용
            const completedToday = 0; // 베이스라인 엔진 실행 이력 API 미구현으로 인한 기본값

            document.getElementById('totalProfiles').textContent = total;
            document.getElementById('activeProfiles').textContent = active;
            document.getElementById('runningBaselines').textContent = running;
            document.getElementById('completedToday').textContent = completedToday;
        }

        // 수동 베이스라인 생성 - 개별 프로파일
        async function runManualBaseline(profileId) {
            try {
                const profile = profiles.find(p => p.id === profileId);

                if (!profile) {
                    showToast('프로파일을 찾을 수 없습니다.', 'error');
                    return;
                }

                const confirmation = confirm(`"${profile.name}" 프로파일의 베이스라인을 수동으로 생성하시겠습니까?\n\n이 작업은 현재 로그 데이터를 분석하여 새로운 베이스라인을 생성합니다.`);

                if (!confirmation) {
                    return;
                }

                showToast('베이스라인 생성을 시작합니다...', 'info');

                // 프록시를 통해 베이스라인 엔진 API 호출 (CORS 문제 해결)
                const response = await fetch('/api/profiles/baseline/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        profileId: profileId
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.jobs && result.jobs.length > 0) {
                        const job = result.jobs[0];
                        showToast(`베이스라인 생성이 시작되었습니다. (작업 ID: ${job.job_id})`, 'success');

                        // 작업 상태 모니터링 시작 (베이스라인 엔진에서 작업 ID가 반환된 경우에만)
                        if (job.job_id) {
                            monitorJobProgress(job.job_id, profile.name);
                        }

                        // 베이스라인 상태 즉시 새로고침
                        setTimeout(() => refreshBaselineStatuses(), 2000);
                    } else {
                        throw new Error('베이스라인 엔진에서 유효한 작업이 생성되지 않았습니다.');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || '베이스라인 생성에 실패했습니다.');
                }
            } catch (error) {
                console.error('Manual baseline creation error:', error);
                showToast(`베이스라인 생성 실패: ${error.message}`, 'error');
            }
        }

        // 작업 진행 상태 모니터링 (베이스라인 엔진 전용)
        async function monitorJobProgress(jobId, profileName) {
            let attempts = 0;
            const maxAttempts = 10; // 최대 약 3분 모니터링 (20초 * 10 = 200초)

            const statusInterval = setInterval(async () => {
                try {
                    attempts++;

                    const statusResponse = await fetch(`/api/profiles/baseline/jobs/${jobId}`);

                    if (statusResponse.ok) {
                        const status = await statusResponse.json();

                        if (status.error) {
                            // 베이스라인 엔진에서 작업 상태를 찾을 수 없는 경우
                            clearInterval(statusInterval);
                            console.warn(`${profileName}: 베이스라인 엔진에서 작업 상태를 조회할 수 없습니다.`);
                            showToast(`${profileName}의 베이스라인 생성이 백그라운드에서 처리됩니다.`, 'info');
                            return;
                        }

                        const progress = status.progress ? (status.progress * 100).toFixed(1) : 0;
                        console.log(`${profileName} 베이스라인 작업 진행률: ${progress}%`);

                        if (status.status === 'completed' || status.status === 'success') {
                            clearInterval(statusInterval);
                            showToast(`${profileName} 베이스라인 생성이 완료되었습니다.`, 'success');
                            refreshBaselineStatuses();
                        } else if (status.status === 'failed' || status.status === 'error') {
                            clearInterval(statusInterval);
                            showToast(`${profileName} 베이스라인 생성이 실패했습니다: ${status.error_message || '알 수 없는 오류'}`, 'error');
                            refreshBaselineStatuses();
                        }
                    } else {
                        console.warn(`${profileName}: 작업 상태 조회 실패: ${statusResponse.status}`);
                    }

                    // 최대 시도 횟수 초과 시 모니터링 중단
                    if (attempts >= maxAttempts) {
                        clearInterval(statusInterval);
                        console.log(`${profileName}: 베이스라인 엔진 모니터링 시간 초과 - 백그라운드에서 처리됩니다.`);
                        showToast(`${profileName}의 베이스라인이 백그라운드에서 처리됩니다.`, 'info');
                    }

                } catch (error) {
                    console.error(`${profileName}: 작업 상태 모니터링 오류:`, error);
                }
            }, 20000); // 20초마다 상태 확인
        }

        // 수동 베이스라인 생성 - 선택된 프로파일들
        async function runManualBaselineForSelected() {
            const selectedCheckboxes = document.querySelectorAll('.profile-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);

            if (selectedIds.length === 0) {
                showToast('베이스라인을 생성할 프로파일을 선택해주세요.', 'warning');
                return;
            }

            const confirmation = confirm(`선택된 ${selectedIds.length}개 프로파일의 베이스라인을 수동으로 생성하시겠습니까?\n\n이 작업은 시간이 오래 걸릴 수 있습니다.`);

            if (!confirmation) {
                return;
            }

            try {
                showToast(`${selectedIds.length}개 프로파일의 베이스라인 생성을 시작합니다...`, 'info');

                // 프록시를 통해 베이스라인 엔진 API 호출 (CORS 문제 해결)
                const response = await fetch('/api/profiles/baseline/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        profileIds: selectedIds
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.jobs && result.jobs.length > 0) {
                        showToast(`${result.jobs.length}개 프로파일의 베이스라인 생성이 시작되었습니다.`, 'success');

                        // 각 작업의 상태 모니터링 시작 (베이스라인 엔진에서 작업 ID가 반환된 경우에만)
                        result.jobs.forEach(job => {
                            if (job.job_id) {
                                const profile = profiles.find(p => p.id === job.profile_id);
                                const profileName = profile ? profile.name : `프로파일 ${job.profile_id}`;
                                monitorJobProgress(job.job_id, profileName);
                            }
                        });

                        // 베이스라인 상태 즉시 새로고침
                        setTimeout(() => refreshBaselineStatuses(), 2000);
                    } else {
                        throw new Error('베이스라인 엔진에서 유효한 작업이 생성되지 않았습니다.');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || '베이스라인 생성에 실패했습니다.');
                }
            } catch (error) {
                console.error('Selected baseline creation error:', error);
                showToast(`베이스라인 생성 실패: ${error.message}`, 'error');
            }
        }

        // 수동 베이스라인 생성 - 전체 프로파일
        async function runManualBaselineForAll() {
            if (profiles.length === 0) {
                showToast('베이스라인을 생성할 프로파일이 없습니다.', 'warning');
                return;
            }

            const confirmation = confirm(`전체 ${profiles.length}개 프로파일의 베이스라인을 수동으로 생성하시겠습니까?\n\n이 작업은 상당한 시간이 소요됩니다.`);

            if (!confirmation) {
                return;
            }

            try {
                showToast(`전체 ${profiles.length}개 프로파일의 베이스라인 생성을 시작합니다...`, 'info');

                const profileIds = profiles.map(p => p.id);

                // 프록시를 통해 베이스라인 엔진 API 호출 (CORS 문제 해결)
                const response = await fetch('/api/profiles/baseline/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        profileIds: profileIds
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.jobs && result.jobs.length > 0) {
                        showToast(`전체 ${result.jobs.length}개 프로파일의 베이스라인 생성이 시작되었습니다.`, 'success');

                        // 각 작업의 상태 모니터링 시작 (베이스라인 엔진에서 작업 ID가 반환된 경우에만)
                        result.jobs.forEach(job => {
                            if (job.job_id) {
                                const profile = profiles.find(p => p.id === job.profile_id);
                                const profileName = profile ? profile.name : `프로파일 ${job.profile_id}`;
                                monitorJobProgress(job.job_id, profileName);
                            }
                        });

                        // 베이스라인 상태 즉시 새로고침
                        setTimeout(() => refreshBaselineStatuses(), 2000);
                    } else {
                        throw new Error('베이스라인 엔진에서 유효한 작업이 생성되지 않았습니다.');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || '베이스라인 생성에 실패했습니다.');
                }
            } catch (error) {
                console.error('All baseline creation error:', error);
                showToast(`전체 베이스라인 생성 실패: ${error.message}`, 'error');
            }
        }

        // 유틸리티 함수들
        function showLoading(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ${message}
                </div>
            `;
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <h3>오류 발생</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">새로고침</button>
                </div>
            `;
        }

        function showToast(message, type = 'info') {
            // 기존 토스트 제거
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }

            // 토스트 요소 생성
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.textContent = message;

            // 문서에 추가
            document.body.appendChild(toast);

            // 애니메이션으로 표시
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 3초 후 제거
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';

            try {
                const date = new Date(dateString);
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.profile-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });

            updateSelectedProfiles();
        }

        function updateSelectedProfiles() {
            const selectedCheckboxes = document.querySelectorAll('.profile-checkbox:checked');
            selectedProfiles = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);

            // 전체 선택 체크박스 상태 업데이트
            const selectAllCheckbox = document.getElementById('selectAll');
            const totalCheckboxes = document.querySelectorAll('.profile-checkbox');

            if (selectAllCheckbox && totalCheckboxes.length > 0) {
                selectAllCheckbox.checked = selectedCheckboxes.length === totalCheckboxes.length;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < totalCheckboxes.length;
            }
        }

        function viewProfile(profileId) {
            window.open(`uba_profile_results.html?id=${profileId}`, '_blank');
        }

        function editProfile(profileId) {
            window.open(`uba_profile_wizard.html?edit=${profileId}`, '_blank');
        }

        function exportHistory() {
            if (executionHistory.length === 0) {
                showToast('내보낼 이력이 없습니다.', 'warning');
                return;
            }

            // CSV 형식으로 데이터 변환
            const headers = ['작업 ID', '프로파일 ID', '프로파일명', '상태', '진행률', '메시지', '시작 시간', '완료 시간'];
            const csvContent = [
                headers.join(','),
                ...executionHistory.map(h => [
                    h.job_id,
                    h.profile_id,
                    h.profile_name || '',
                    h.status,
                    h.progress_percentage || 0,
                    (h.message || '').replace(/,/g, ';'),
                    h.created_at,
                    h.completed_at || ''
                ].join(','))
            ].join('\n');

            // 파일 다운로드
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `uba_baseline_history_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('실행 이력이 CSV 파일로 내보내졌습니다.', 'success');
        }

        // 베이스라인 상태만 새로고침 (성능 향상)
        async function refreshBaselineStatuses() {
            try {
                console.log('베이스라인 상태만 새로고침 시작');

                // 각 프로파일의 베이스라인 상태 조회
                await loadProfileBaselineStatuses();

                // 테이블만 다시 렌더링
                renderProfileTable();

                // 통계 업데이트
                updateProfileStats();

                // 실행 이력 탭이 활성화되어 있다면 실행 이력도 새로고침
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'execution-history') {
                    console.log('실행 이력 탭이 활성화되어 있으므로 실행 이력도 새로고침');
                    refreshHistory();
                }

                console.log('베이스라인 상태 새로고침 완료');
            } catch (error) {
                console.error('베이스라인 상태 새로고침 실패:', error);
            }
        }
    </script>
</body>
</html>
