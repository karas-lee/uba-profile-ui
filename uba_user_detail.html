<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBA 개별 사용자 상세 분석</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-top: 20px;
        }

        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 2rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .user-details-large {
            flex: 1;
        }

        .user-details-large h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .risk-status {
            position: absolute;
            top: 30px;
            right: 30px;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-status.high {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .risk-status.medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .risk-status.normal {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .main-content {
            padding: 30px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 2px;
        }

        .metric-comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .metric-comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1200px) {
            .metric-comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1600px) {
            .metric-comparison-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .metric-card {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(51, 65, 85, 0.3);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .metric-name {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .metric-status {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-normal {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .status-alert {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .metric-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .comparison-side {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .comparison-title {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .comparison-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 6px;
        }

        .comparison-description {
            font-size: 0.8rem;
            color: #94a3b8;
            line-height: 1.4;
        }

        .deviation-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .deviation-arrow {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .deviation-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .deviation-up {
            color: #ef4444;
        }

        .deviation-normal {
            color: #22c55e;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .baseline-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .baseline-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .baseline-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .baseline-card.individual::before {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .baseline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .baseline-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .baseline-score {
            font-size: 2.5rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 15px;
            color: white;
            text-align: center;
            min-width: 100px;
        }

        .score-common {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .score-individual {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .footer {
            background: #ecf0f1;
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background: #fff5f5;
            border-radius: 10px;
            margin: 20px 0;
        }

        @media (max-width: 1024px) {
            .baseline-comparison {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .user-profile {
                flex-direction: column;
                text-align: center;
            }

            .user-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="uba_user_list.html" class="back-btn">← 사용자 목록</a>
            <div id="riskStatus" class="risk-status">분석 중...</div>

            <div class="user-profile">
                <div class="user-avatar-large" id="userAvatar">U</div>
                <div class="user-details-large">
                    <h1 id="userName">사용자 상세 분석</h1>
                    <div class="user-info-grid">
                        <div class="info-item">
                            <span id="userEmail">📧 분석 중...</span>
                        </div>
                        <div class="info-item">
                            <span id="userDept">🏢 부서 정보 로딩...</span>
                        </div>
                        <div class="info-item">
                            <span id="analysisPeriod">📅 분석 기간 확인 중...</span>
                        </div>
                        <div class="info-item">
                            <span id="lastAccess">⏰ 마지막 접속 조회 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <section id="baselineComparisonSection">
                <h2 class="section-title">🔍 공통 베이스라인 vs 개별 베이스라인 비교 분석</h2>

                <div class="baseline-comparison">
                    <div class="baseline-card common">
                        <div class="baseline-header">
                            <h3 class="baseline-title">📊 공통 베이스라인 기준</h3>
                            <div id="commonScore" class="baseline-score score-common">--</div>
                        </div>
                        <div id="commonMetrics">
                            <div class="loading">공통 베이스라인 데이터 로딩 중...</div>
                        </div>
                    </div>

                    <div class="baseline-card individual">
                        <div class="baseline-header">
                            <h3 class="baseline-title">👤 개별 베이스라인 기준</h3>
                            <div id="individualScore" class="baseline-score score-individual">--</div>
                        </div>
                        <div id="individualMetrics">
                            <div class="loading">개별 베이스라인 데이터 로딩 중...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="metricComparisonSection">
                <h3 class="section-title">📈 메트릭별 베이스라인 비교</h3>
                <div id="metricComparisonGrid" class="metric-comparison-grid">
                    <div class="loading">메트릭 데이터 로딩 중...</div>
                </div>
            </section>

            <section id="chartsSection">
                <h3 class="section-title">📊 행동 패턴 시각화</h3>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">시간대별 활동 패턴</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="timePatternChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">주간 활동 분포</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="weeklyPatternChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">메트릭 품질 점수</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityScoreChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">이상치 탐지 현황</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="anomalyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>UBA Individual Baseline Analysis System v2.1 | 개별 베이스라인 기반 사용자 행동 분석</p>
        </footer>
    </div>

    <script>
        // 전역 변수
        let currentUserId = null;
        let currentProfileId = 'ce8bde1e-5b43-4790-943f-aedc076b6574'; // 실제 프로파일 ID
        let individualBaselines = [];
        let commonBaselines = [];
        let comparisons = [];
        let anomalies = [];
        let temporalPatterns = [];
        let qualityData = {};

        // URL 파라미터 파싱
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            currentUserId = getURLParameter('user');
            if (currentUserId) {
                initializeUserDetail(currentUserId);
            } else {
                showError('사용자 ID가 제공되지 않았습니다.');
            }
        });

        // 사용자 상세 정보 초기화
        async function initializeUserDetail(userId) {
            try {
                // 사용자 기본 정보 설정
                updateUserInfo(userId);

                // API 데이터 로드
                await Promise.all([
                    loadIndividualBaselines(userId),
                    loadAnomalies(userId),
                    loadTemporalPatterns(userId),
                    loadQualityData(userId)
                ]);

                // UI 업데이트
                updateBaselineComparison();
                updateMetricComparison();
                updateCharts();
                updateRiskStatus();

            } catch (error) {
                console.error('사용자 상세 분석 초기화 실패:', error);
                showError('데이터 로딩 중 오류가 발생했습니다.');
            }
        }

        // 사용자 기본 정보 업데이트
        function updateUserInfo(userId) {
            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');
            const email = document.getElementById('userEmail');
            const dept = document.getElementById('userDept');
            const period = document.getElementById('analysisPeriod');
            const lastAccess = document.getElementById('lastAccess');

            // 사용자 정보 (실제로는 API에서 가져와야 함)
            const userInfo = {
                name: userId === 'user0001' ? '김철수' : `사용자 ${userId}`,
                email: `${userId}@company.com`,
                dept: '개발팀',
                avatar: userId.charAt(userId.length - 1).toUpperCase()
            };

            avatar.textContent = userInfo.avatar;
            name.textContent = `${userInfo.name} 상세 분석`;
            email.innerHTML = `📧 ${userInfo.email}`;
            dept.innerHTML = `🏢 ${userInfo.dept}`;
            period.innerHTML = `📅 분석 기간: 최근 30일`;
            lastAccess.innerHTML = `⏰ 마지막 분석: ${new Date().toLocaleString()}`;
        }

        // 개별 베이스라인 데이터 로드
        async function loadIndividualBaselines(userId) {
            try {
                const response = await fetch(`/api/baseline-details/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('개별 베이스라인 데이터 로드 실패');

                const data = await response.json();
                individualBaselines = data.individual_baselines || [];
                commonBaselines = data.common_baselines || [];
                comparisons = data.comparisons || [];
                console.log('개별 베이스라인 데이터:', individualBaselines);
                console.log('공통 베이스라인 데이터:', commonBaselines);
                console.log('비교 데이터:', comparisons);
            } catch (error) {
                console.error('개별 베이스라인 로드 오류:', error);
                individualBaselines = [];
                commonBaselines = [];
                comparisons = [];
            }
        }

        // 이상치 데이터 로드
        async function loadAnomalies(userId) {
            try {
                const response = await fetch(`/api/anomalies/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('이상치 데이터 로드 실패');

                const data = await response.json();
                anomalies = data.anomalies || [];
                console.log('이상치 데이터:', anomalies);
            } catch (error) {
                console.error('이상치 로드 오류:', error);
                anomalies = [];
            }
        }

        // 시간대별 패턴 데이터 로드
        async function loadTemporalPatterns(userId) {
            try {
                const response = await fetch(`/api/temporal-patterns/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('시간대별 패턴 데이터 로드 실패');

                const data = await response.json();
                temporalPatterns = data.patterns || [];
                console.log('시간대별 패턴 데이터:', temporalPatterns);
            } catch (error) {
                console.error('시간대별 패턴 로드 오류:', error);
                temporalPatterns = [];
            }
        }

        // 품질 데이터 로드
        async function loadQualityData(userId) {
            try {
                const response = await fetch(`/api/baseline-quality/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('품질 데이터 로드 실패');

                const data = await response.json();
                qualityData = data;
                console.log('품질 데이터:', qualityData);
            } catch (error) {
                console.error('품질 데이터 로드 오류:', error);
                qualityData = {};
            }
        }

        // 베이스라인 비교 업데이트
        function updateBaselineComparison() {
            const commonScore = document.getElementById('commonScore');
            const individualScore = document.getElementById('individualScore');
            const commonMetrics = document.getElementById('commonMetrics');
            const individualMetrics = document.getElementById('individualMetrics');

            // 점수 계산
            const avgQuality = individualBaselines.length > 0
                ? Math.round(individualBaselines.reduce((sum, b) => sum + b.quality_score, 0) / individualBaselines.length * 100)
                : 75;

            const commonQualityScore = 85; // 공통 베이스라인 기본 점수

            commonScore.textContent = commonQualityScore;
            individualScore.textContent = avgQuality;

            // 공통 베이스라인 메트릭
            commonMetrics.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">평균 품질</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${commonQualityScore}%</div>
                        <div style="font-size: 0.8rem; color: #28a745;">안정적</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">사용자 수</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">187명</div>
                        <div style="font-size: 0.8rem; color: #007bff;">전체 기준</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">학습 기간</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">30일</div>
                        <div style="font-size: 0.8rem; color: #17a2b8;">표준</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">메트릭 수</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">15개</div>
                        <div style="font-size: 0.8rem; color: #6f42c1;">VPN 기반</div>
                    </div>
                </div>
            `;

            // 개별 베이스라인 메트릭
            const anomalyCount = anomalies.length;
            const dataPoints = individualBaselines.length > 0 ? individualBaselines[0].data_points_count : 1000;

            individualMetrics.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">개별 품질</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${avgQuality}%</div>
                        <div style="font-size: 0.8rem; color: ${avgQuality >= 80 ? '#28a745' : avgQuality >= 60 ? '#ffc107' : '#dc3545'};">
                            ${avgQuality >= 80 ? '우수' : avgQuality >= 60 ? '보통' : '개선 필요'}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">이상치 수</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${anomalyCount}개</div>
                        <div style="font-size: 0.8rem; color: ${anomalyCount > 5 ? '#dc3545' : anomalyCount > 2 ? '#ffc107' : '#28a745'};">
                            ${anomalyCount > 5 ? '높음' : anomalyCount > 2 ? '보통' : '낮음'}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">데이터 포인트</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${dataPoints.toLocaleString()}개</div>
                        <div style="font-size: 0.8rem; color: #17a2b8;">충분함</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">분석 메트릭</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${individualBaselines.length}개</div>
                        <div style="font-size: 0.8rem; color: #6f42c1;">개인화됨</div>
                    </div>
                </div>
            `;
        }

        // 메트릭별 정상 범위 비교 데이터 준비
        function prepareMetricComparisonData(metricName, individualRange, commonRange) {
            const metricConfig = {
                // 시간 기반 메트릭
                'login_time_pattern': {
                    type: 'time_based',
                    title: '정상 로그인 시간',
                    unit: '시간',
                    chartType: 'timeline'
                },
                'after_hours_activity': {
                    type: 'time_based',
                    title: '업무시간 외 활동 허용범위',
                    unit: '시간',
                    chartType: 'timeline'
                },
                'weekend_holiday_access': {
                    type: 'threshold',
                    title: '주말/휴일 접속 허용수준',
                    unit: '횟수/주',
                    chartType: 'bar'
                },

                // 세션 기반 메트릭
                'session_duration': {
                    type: 'statistical',
                    title: '정상 세션 지속시간',
                    unit: '분',
                    chartType: 'range'
                },
                'concurrent_session_detection': {
                    type: 'threshold',
                    title: '동시 세션 허용개수',
                    unit: '개',
                    chartType: 'bar'
                },
                'login_frequency_change': {
                    type: 'statistical',
                    title: '로그인 빈도 변화 허용범위',
                    unit: '%',
                    chartType: 'range'
                },

                // 네트워크 기반 메트릭
                'ip_address_pattern': {
                    type: 'categorical',
                    title: '허용 IP 패턴',
                    unit: '패턴',
                    chartType: 'text'
                },
                'geo_location_analysis': {
                    type: 'categorical',
                    title: '허용 지역 범위',
                    unit: '지역',
                    chartType: 'text'
                },
                'vpn_usage_pattern': {
                    type: 'statistical',
                    title: 'VPN 사용 패턴',
                    unit: '시간/일',
                    chartType: 'range'
                },
                'bandwidth_usage_anomaly': {
                    type: 'statistical',
                    title: '대역폭 사용량 정상범위',
                    unit: 'GB/일',
                    chartType: 'range'
                },

                // 기타 메트릭
                'impossible_travel_detection': {
                    type: 'threshold',
                    title: '이동 속도 임계값',
                    unit: 'km/h',
                    chartType: 'bar'
                },
                'network_device_change': {
                    type: 'threshold',
                    title: '기기 변경 허용빈도',
                    unit: '회/월',
                    chartType: 'bar'
                },
                'connection_pattern_analysis': {
                    type: 'statistical',
                    title: '연결 패턴 정상범위',
                    unit: '연결/시간',
                    chartType: 'range'
                },
                'timezone_anomaly_access': {
                    type: 'categorical',
                    title: '허용 시간대',
                    unit: '시간대',
                    chartType: 'text'
                },
                'data_volume_transfer': {
                    type: 'statistical',
                    title: '데이터 전송량 정상범위',
                    unit: 'GB/일',
                    chartType: 'range'
                }
            };

            const config = metricConfig[metricName] || {
                type: 'statistical',
                title: '정상 범위',
                unit: '',
                chartType: 'range'
            };

            return {
                config: config,
                individual: individualRange,
                common: commonRange
            };
        }

        // 정상 범위 비교 컨텐츠 생성
        function generateComparisonContent(comparisonData, qualityScore) {
            const { config, individual, common } = comparisonData;

            if (config.chartType === 'text') {
                return generateTextComparison(config, individual, common, qualityScore);
            } else if (config.type === 'time_based') {
                return generateTimeBasedComparison(config, individual, common, qualityScore);
            } else if (config.type === 'statistical') {
                return generateStatisticalComparison(config, individual, common, qualityScore);
            } else if (config.type === 'threshold') {
                return generateThresholdComparison(config, individual, common, qualityScore);
            } else {
                return generateStatisticalComparison(config, individual, common, qualityScore);
            }
        }

        // 텍스트 기반 비교 (IP 패턴, 지역 등)
        function generateTextComparison(config, individual, common, qualityScore) {
            // human_readable 우선 사용, 없으면 기존 방식
            let individualDisplay = individual?.human_readable;
            if (!individualDisplay) {
                if (individual?.categorical_range &&
                    typeof individual.categorical_range === 'object' &&
                    Object.keys(individual.categorical_range).length > 0) {
                    individualDisplay = Object.entries(individual.categorical_range).map(([key, value]) =>
                        `${key}: ${Array.isArray(value) ? value.join(', ') : value}`
                    ).join('<br>');
                } else {
                    individualDisplay = '데이터 학습 중...';
                }
            }

            let commonDisplay = common?.human_readable;
            if (!commonDisplay) {
                if (common?.categorical_range &&
                    typeof common.categorical_range === 'object' &&
                    Object.keys(common.categorical_range).length > 0) {
                    commonDisplay = Object.entries(common.categorical_range).map(([key, value]) =>
                        `${key}: ${Array.isArray(value) ? value.join(', ') : value}`
                    ).join('<br>');
                } else {
                    commonDisplay = '데이터 학습 중...';
                }
            }

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">👤 개별 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">품질: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 1rem; font-weight: 500; color: #2980b9;">
                            ${individualDisplay}
                        </div>
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">👥 공통 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">187명 기준</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px;">
                        <div style="font-size: 1rem; font-weight: 500; color: #27ae60;">
                            ${commonDisplay}
                        </div>
                    </div>
                </div>
            `;
        }

        // 시간 기반 비교 (로그인 시간, 업무시간 외 활동 등)
        function generateTimeBasedComparison(config, individual, common, qualityScore) {
            // human_readable 우선 사용
            const individualDisplay = individual?.human_readable || (() => {
                const timeData = individual?.time_based_range || individual?.statistical_range || {};
                if (timeData.start_hour !== undefined && timeData.end_hour !== undefined) {
                    return `${String(timeData.start_hour).padStart(2, '0')}:00 - ${String(timeData.end_hour).padStart(2, '0')}:00`;
                } else if (timeData.mean_hour !== undefined) {
                    const meanHour = Math.round(timeData.mean_hour);
                    const stdHour = Math.round(timeData.std_deviation || 2);
                    return `${String(Math.max(0, meanHour - stdHour)).padStart(2, '0')}:00 - ${String(Math.min(23, meanHour + stdHour)).padStart(2, '0')}:00`;
                }
                return '학습 중...';
            })();

            const commonDisplay = common?.human_readable || (() => {
                const timeData = common?.time_based_range || common?.statistical_range || {};
                if (timeData.start_hour !== undefined && timeData.end_hour !== undefined) {
                    return `${String(timeData.start_hour).padStart(2, '0')}:00 - ${String(timeData.end_hour).padStart(2, '0')}:00`;
                } else if (timeData.mean_hour !== undefined) {
                    const meanHour = Math.round(timeData.mean_hour);
                    const stdHour = Math.round(timeData.std_deviation || 2);
                    return `${String(Math.max(0, meanHour - stdHour)).padStart(2, '0')}:00 - ${String(Math.min(23, meanHour + stdHour)).padStart(2, '0')}:00`;
                }
                return '학습 중...';
            })();

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">👤 개별 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">품질: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #2980b9; margin-bottom: 4px;">
                            🕐 ${individualDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">정상 활동 범위</div>
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">👥 공통 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">187명 기준</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60; margin-bottom: 4px;">
                            🕐 ${commonDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">일반적인 활동 범위</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                    <div style="color: #666; text-align: center;">
                        💡 이 범위를 벗어난 활동은 이상 행동으로 감지될 수 있습니다
                    </div>
                </div>
            `;
        }

        // 통계적 비교 (세션 시간, 빈도 등)
        function generateStatisticalComparison(config, individual, common, qualityScore) {
            // human_readable 우선 사용
            const individualDisplay = individual?.human_readable || (() => {
                const stats = individual?.statistical_range || {};
                const mean = stats.mean_hour || 0;
                const std = stats.std_deviation || 0;
                return `${(mean - 2 * std).toFixed(1)} - ${(mean + 2 * std).toFixed(1)} ${config.unit}`;
            })();

            const commonDisplay = common?.human_readable || (() => {
                const stats = common?.statistical_range || {};
                const mean = stats.mean_hour || 0;
                const std = stats.std_deviation || 0;
                return `${(mean - 2 * std).toFixed(1)} - ${(mean + 2 * std).toFixed(1)} ${config.unit}`;
            })();

            // 평균값도 표시 (human_readable이 범위만 포함할 수 있으므로)
            const individualMean = individual?.statistical_range?.mean_hour || 0;
            const commonMean = common?.statistical_range?.mean_hour || 0;

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">👤 개별 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">품질: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.9rem; color: #666;">정상 범위:</span>
                            <span style="font-weight: bold; color: #2980b9;">${individualDisplay}</span>
                        </div>
                        ${individualMean > 0 ? `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9rem; color: #666;">평균값:</span>
                            <span style="font-weight: bold; color: #2980b9;">${individualMean.toFixed(1)} ${config.unit}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">👥 공통 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">187명 기준</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.9rem; color: #666;">정상 범위:</span>
                            <span style="font-weight: bold; color: #27ae60;">${commonDisplay}</span>
                        </div>
                        ${commonMean > 0 ? `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9rem; color: #666;">평균값:</span>
                            <span style="font-weight: bold; color: #27ae60;">${commonMean.toFixed(1)} ${config.unit}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 임계값 기반 비교 (동시 세션, 기기 변경 등)
        function generateThresholdComparison(config, individual, common, qualityScore) {
            // human_readable 우선 사용
            const individualDisplay = individual?.human_readable || (() => {
                const threshold = individual?.threshold_range || individual?.statistical_range || {};
                const maxValue = threshold.max_value || threshold.mean_hour || 0;
                return `≤ ${maxValue.toFixed(0)} ${config.unit}`;
            })();

            const commonDisplay = common?.human_readable || (() => {
                const threshold = common?.threshold_range || common?.statistical_range || {};
                const maxValue = threshold.max_value || threshold.mean_hour || 0;
                return `≤ ${maxValue.toFixed(0)} ${config.unit}`;
            })();

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">👤 개별 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">품질: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #2980b9; margin-bottom: 4px;">
                            ${individualDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">허용 임계값</div>
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">👥 공통 베이스라인</span>
                        <span style="font-size: 0.9rem; color: #666;">187명 기준</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60; margin-bottom: 4px;">
                            ${commonDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">일반적인 임계값</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                    <div style="color: #666; text-align: center;">
                        ⚠️ 이 값을 초과하면 이상 행동으로 탐지됩니다
                    </div>
                </div>
            `;
        }

        // 메트릭 비교 업데이트
        function updateMetricComparison() {
            const container = document.getElementById('metricComparisonGrid');

            if (!individualBaselines || individualBaselines.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">메트릭 데이터가 없습니다.</div>';
                return;
            }

            // 메트릭 한글 매핑
            const metricNameMap = {
                'login_time_pattern': '로그인 시간 패턴',
                'session_duration': '세션 지속 시간',
                'after_hours_activity': '시간 외 활동',
                'weekend_holiday_access': '주말/휴일 접속',
                'login_frequency_change': '로그인 빈도 변화',
                'concurrent_session_detection': '동시 세션 감지',
                'timezone_anomaly_access': '시간대 이상 접속',
                'ip_address_pattern': 'IP 주소 패턴',
                'geo_location_analysis': '지리적 위치 분석',
                'data_volume_transfer': '데이터 전송량',
                'impossible_travel_detection': '불가능한 이동 감지',
                'vpn_usage_pattern': 'VPN 사용 패턴',
                'network_device_change': '네트워크 기기 변경',
                'bandwidth_usage_anomaly': '대역폭 사용 이상',
                'connection_pattern_analysis': '연결 패턴 분석'
            };

            // 유효한 메트릭만 필터링 (실제 베이스라인 데이터가 있는 것만)
            const validMetrics = individualBaselines.filter(baseline =>
                metricNameMap[baseline.metric_name] &&
                baseline.normal_range &&
                baseline.normal_range.statistical_range
            );

            // 실제 데이터가 없는 경우 알림
            if (validMetrics.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.95); border-radius: 15px; margin: 20px 0;">
                        <div style="font-size: 2rem; margin-bottom: 15px;">⏳</div>
                        <h3 style="color: #e67e22; margin-bottom: 10px;">베이스라인 학습 진행 중</h3>
                        <p style="color: #666; margin-bottom: 15px;">아직 충분한 데이터가 수집되지 않았습니다.</p>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>학습 상태:</strong> 베이스라인 엔진에서 사용자 패턴을 분석 중입니다.<br>
                            <strong>예상 완료:</strong> 충분한 데이터 수집 후 자동으로 분석이 시작됩니다.
                        </div>
                        <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            🔄 새로고침
                        </button>
                    </div>
                `;

                const titleElement = document.querySelector('#metricComparisonSection .section-title');
                if (titleElement) {
                    titleElement.innerHTML = `📊 메트릭별 베이스라인 범위 비교 <span style="font-size: 1rem; color: #e67e22;">(학습 중...)</span>`;
                }
                return;
            }

            let html = '';
            validMetrics.forEach((baseline, index) => {
                const metricName = metricNameMap[baseline.metric_name];
                const qualityScore = Math.round(baseline.quality_score * 100);

                // 품질 점수에 따른 상태 결정
                let status = 'normal';
                if (qualityScore < 60) status = 'alert';
                else if (qualityScore < 80) status = 'warning';

                // 해당 메트릭의 이상치 정보 찾기
                const anomaly = anomalies?.find(a => a.metric_name === baseline.metric_name);

                // 공통 베이스라인 찾기
                const commonBaseline = commonBaselines?.find(cb => cb.metric_name === baseline.metric_name);

                // 비교 데이터 찾기
                const comparison = comparisons?.find(c => c.metric_name === baseline.metric_name);

                // 실제 베이스라인 통계값 사용
                const individualMean = baseline.normal_range.statistical_range.mean_hour || 0;
                const individualStd = baseline.normal_range.statistical_range.std_deviation || 1;
                const commonMean = commonBaseline?.normal_range?.statistical_range?.mean_hour || individualMean;
                const commonStd = commonBaseline?.normal_range?.statistical_range?.std_deviation || individualStd;

                // 정상 범위 데이터 추출
                const individualNormalRange = baseline.normal_range;
                const commonNormalRange = commonBaseline?.normal_range;

                // 메트릭별 정상 범위 비교 데이터 준비
                const comparisonData = prepareMetricComparisonData(baseline.metric_name, individualNormalRange, commonNormalRange);

                // 차트 ID 생성
                const chartId = `metricChart_${index}`;

                // 정상 범위 비교 컨텐츠 생성
                const comparisonContent = generateComparisonContent(comparisonData, qualityScore);

                html += `
                    <div class="metric-card" style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div class="metric-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="metric-name" style="font-size: 1.1rem; font-weight: bold; color: #2c3e50;">${metricName}</div>
                            <div class="metric-status status-${status}" style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;
                                ${status === 'alert' ? 'background: #e74c3c; color: white;' :
                                  status === 'warning' ? 'background: #f39c12; color: white;' :
                                  'background: #27ae60; color: white;'}">
                                ${status === 'alert' ? '⚠️ 경고' : status === 'warning' ? '⚡ 주의' : '✅ 정상'}
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1rem;">📊 ${comparisonData.config.title}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; align-items: flex-start;">
                                <!-- 정상 범위 비교 정보 -->
                                <div class="normal-range-comparison">
                                    ${comparisonContent}
                                </div>

                                <!-- 메트릭별 차트/시각화 -->
                                <div class="metric-visualization">
                                    ${comparisonData.config.chartType !== 'text' ?
                                        `<canvas id="${chartId}" style="max-height: 200px; max-width: 280px;"></canvas>` :
                                        '<div style="padding: 20px; text-align: center; color: #666; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">차트 시각화 준비 중</div>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // 제목 업데이트
            const titleElement = document.querySelector('#metricComparisonSection .section-title');
            if (titleElement) {
                titleElement.innerHTML = `📊 메트릭별 베이스라인 범위 비교 <span style="font-size: 1rem; color: #666;">(총 ${validMetrics.length}개 메트릭)</span>`;
            }

            // 각 메트릭에 대한 정상 범위 차트 생성
            setTimeout(() => {
                validMetrics.forEach((baseline, index) => {
                    const comparisonData = prepareMetricComparisonData(baseline.metric_name, baseline.normal_range,
                        commonBaselines?.find(cb => cb.metric_name === baseline.metric_name)?.normal_range);
                    if (comparisonData.config.chartType !== 'text') {
                        createMetricNormalRangeChart(comparisonData, baseline, index);
                    }
                });
            }, 100);
        }

        // 메트릭별 정상 범위 차트 생성
        function createMetricNormalRangeChart(comparisonData, baseline, index) {
            const chartId = `metricChart_${index}`;
            const ctx = document.getElementById(chartId);
            if (!ctx) return;

            const { config, individual, common } = comparisonData;

            // 차트 타입에 따른 분기
            if (config.chartType === 'timeline') {
                createTimelineChart(ctx, config, individual, common);
            } else if (config.chartType === 'range') {
                createRangeChart(ctx, config, individual, common);
            } else if (config.chartType === 'bar') {
                createThresholdChart(ctx, config, individual, common);
            } else {
                createDefaultChart(ctx, config, individual, common);
            }
        }

        // 시간대별 차트 (로그인 시간, 업무시간 외 활동)
        function createTimelineChart(ctx, config, individual, common) {
            const hours = Array.from({length: 24}, (_, i) => i);
            const individualTime = individual?.time_based_range || individual?.statistical_range || {};
            const commonTime = common?.time_based_range || common?.statistical_range || {};

            // 정상 시간대 범위 계산
            const getTimeRange = (timeData) => {
                if (timeData.start_hour !== undefined && timeData.end_hour !== undefined) {
                    return { start: timeData.start_hour, end: timeData.end_hour };
                } else if (timeData.mean_hour !== undefined) {
                    const mean = timeData.mean_hour;
                    const std = timeData.std_deviation || 2;
                    return { start: Math.max(0, mean - std), end: Math.min(23, mean + std) };
                }
                return { start: 9, end: 18 }; // 기본값
            };

            const individualRange = getTimeRange(individualTime);
            const commonRange = getTimeRange(commonTime);

            const individualData = hours.map(h =>
                h >= individualRange.start && h <= individualRange.end ? 1 : 0
            );
            const commonData = hours.map(h =>
                h >= commonRange.start && h <= commonRange.end ? 0.8 : 0
            );

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: '개별 정상시간',
                            data: individualData,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: '공통 정상시간',
                            data: commonData,
                            backgroundColor: 'rgba(39, 174, 96, 0.6)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 10 } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { font: { size: 8 }, maxTicksLimit: 8 }
                        },
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: { font: { size: 8 }, display: false }
                        }
                    }
                }
            });
        }

        // 범위 차트 (세션 시간, 빈도 등)
        function createRangeChart(ctx, config, individual, common) {
            const individualStats = individual?.statistical_range || {};
            const commonStats = common?.statistical_range || {};

            const individualMean = individualStats.mean_hour || 0;
            const individualStd = individualStats.std_deviation || 0;
            const commonMean = commonStats.mean_hour || individualMean;
            const commonStd = commonStats.std_deviation || individualStd;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['개별', '공통'],
                    datasets: [
                        {
                            label: '평균값',
                            data: [individualMean, commonMean],
                            backgroundColor: ['rgba(52, 152, 219, 0.6)', 'rgba(39, 174, 96, 0.6)'],
                            borderColor: ['#3498db', '#27ae60'],
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.unit,
                                font: { size: 9 }
                            },
                            ticks: { font: { size: 8 } }
                        }
                    }
                }
            });
        }

        // 임계값 차트 (동시 세션, 기기 변경)
        function createThresholdChart(ctx, config, individual, common) {
            const individualThreshold = individual?.threshold_range || individual?.statistical_range || {};
            const commonThreshold = common?.threshold_range || common?.statistical_range || {};

            const individualMax = individualThreshold.max_value || individualThreshold.mean_hour || 0;
            const commonMax = commonThreshold.max_value || commonThreshold.mean_hour || individualMax;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['개별 임계값', '공통 임계값'],
                    datasets: [{
                        data: [individualMax, commonMax],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(39, 174, 96, 0.8)'
                        ],
                        borderColor: ['#3498db', '#27ae60'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { font: { size: 9 } }
                        }
                    }
                }
            });
        }

        // 기본 차트
        function createDefaultChart(ctx, config, individual, common) {
            createRangeChart(ctx, config, individual, common);
        }

        // 위험도 상태 업데이트
        function updateRiskStatus() {
            const riskStatus = document.getElementById('riskStatus');

            if (!individualBaselines || individualBaselines.length === 0) {
                riskStatus.textContent = '분석 중...';
                riskStatus.className = 'risk-status normal';
                return;
            }

            const avgQuality = individualBaselines.reduce((sum, b) => sum + b.quality_score, 0) / individualBaselines.length * 100;
            const anomalyCount = anomalies.length;

            let riskLevel = 'normal';
            let riskText = '정상';

            if (anomalyCount > 5 || avgQuality < 60) {
                riskLevel = 'high';
                riskText = '고위험';
            } else if (anomalyCount > 2 || avgQuality < 80) {
                riskLevel = 'medium';
                riskText = '주의';
            }

            riskStatus.textContent = riskText;
            riskStatus.className = `risk-status ${riskLevel}`;
        }

        // 차트 업데이트
        function updateCharts() {
            updateTimePatternChart();
            updateWeeklyPatternChart();
            updateQualityScoreChart();
            updateAnomalyChart();
        }

        // 시간대별 패턴 차트
        function updateTimePatternChart() {
            const ctx = document.getElementById('timePatternChart').getContext('2d');

            // 실제 데이터 또는 샘플 데이터 사용
            const hours = Array.from({length: 24}, (_, i) => i);
            const baselineData = hours.map(() => Math.random() * 50 + 25);
            const currentData = hours.map(() => Math.random() * 60 + 20);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: '개별 베이스라인',
                        data: baselineData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }, {
                        label: '현재 패턴',
                        data: currentData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '활동 빈도 (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '시간'
                            }
                        }
                    }
                }
            });
        }

        // 주간 패턴 차트
        function updateWeeklyPatternChart() {
            const ctx = document.getElementById('weeklyPatternChart').getContext('2d');

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'],
                    datasets: [{
                        label: '개별 베이스라인',
                        data: [85, 90, 88, 92, 87, 15, 8],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderWidth: 2
                    }, {
                        label: '현재 패턴',
                        data: [88, 85, 90, 95, 89, 45, 35],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // 품질 점수 차트
        function updateQualityScoreChart() {
            const ctx = document.getElementById('qualityScoreChart').getContext('2d');

            if (!individualBaselines || individualBaselines.length === 0) {
                ctx.fillText('데이터가 없습니다', 100, 100);
                return;
            }

            const metricNames = individualBaselines
                .filter(b => b.metric_name !== 'data_volume_transfer')
                .map(baseline => {
                    const nameMap = {
                        'login_time_pattern': '로그인 시간',
                        'session_duration': '세션 지속',
                        'vpn_usage_pattern': 'VPN 사용',
                        'geo_location_analysis': '위치 분석'
                    };
                    return nameMap[baseline.metric_name] || baseline.metric_name.substring(0, 8);
                }).slice(0, 8);

            const qualityScores = individualBaselines
                .filter(b => b.metric_name !== 'data_volume_transfer')
                .map(baseline => Math.round(baseline.quality_score * 100))
                .slice(0, 8);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: metricNames,
                    datasets: [{
                        label: '품질 점수 (%)',
                        data: qualityScores,
                        backgroundColor: qualityScores.map(score =>
                            score >= 80 ? '#27ae60' : score >= 60 ? '#f39c12' : '#e74c3c'
                        ),
                        borderColor: '#2c3e50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '품질 점수 (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '메트릭'
                            }
                        }
                    }
                }
            });
        }

        // 이상치 탐지 차트
        function updateAnomalyChart() {
            const ctx = document.getElementById('anomalyChart').getContext('2d');

            const anomalyCount = anomalies.length;
            const normalCount = individualBaselines.length - anomalyCount;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['정상', '이상치 탐지'],
                    datasets: [{
                        data: [normalCount, anomalyCount],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 오류 표시
        function showError(message) {
            const main = document.querySelector('.main-content');
            main.innerHTML = `<div class="error">❌ ${message}</div>`;
        }

        // 애니메이션 효과
        document.addEventListener('DOMContentLoaded', function() {
            // 차트 카드 애니메이션
            setTimeout(() => {
                document.querySelectorAll('.chart-card').forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';

                    setTimeout(() => {
                        card.style.transition = 'all 0.6s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 200);
                });
            }, 1000);

            // 베이스라인 카드 호버 효과
            document.querySelectorAll('.baseline-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                    this.style.boxShadow = '0 15px 30px rgba(0, 0, 0, 0.15)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                    this.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.1)';
                });
            });
        });
    </script>
</body>
</html>
