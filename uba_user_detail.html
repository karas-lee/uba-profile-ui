<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBA ê°œë³„ ì‚¬ìš©ì ìƒì„¸ ë¶„ì„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-top: 20px;
        }

        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 2rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .user-details-large {
            flex: 1;
        }

        .user-details-large h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .risk-status {
            position: absolute;
            top: 30px;
            right: 30px;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-status.high {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .risk-status.medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .risk-status.normal {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .main-content {
            padding: 30px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 2px;
        }

        .metric-comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .metric-comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1200px) {
            .metric-comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1600px) {
            .metric-comparison-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .metric-card {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(51, 65, 85, 0.3);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .metric-name {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .metric-status {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-normal {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .status-alert {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .metric-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .comparison-side {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .comparison-title {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .comparison-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 6px;
        }

        .comparison-description {
            font-size: 0.8rem;
            color: #94a3b8;
            line-height: 1.4;
        }

        .deviation-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .deviation-arrow {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .deviation-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .deviation-up {
            color: #ef4444;
        }

        .deviation-normal {
            color: #22c55e;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .baseline-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .baseline-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .baseline-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .baseline-card.individual::before {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .baseline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .baseline-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .baseline-score {
            font-size: 2.5rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 15px;
            color: white;
            text-align: center;
            min-width: 100px;
        }

        .score-common {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .score-individual {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .footer {
            background: #ecf0f1;
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background: #fff5f5;
            border-radius: 10px;
            margin: 20px 0;
        }

        @media (max-width: 1024px) {
            .baseline-comparison {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .user-profile {
                flex-direction: column;
                text-align: center;
            }

            .user-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="uba_user_list.html" class="back-btn">â† ì‚¬ìš©ì ëª©ë¡</a>
            <div id="riskStatus" class="risk-status">ë¶„ì„ ì¤‘...</div>

            <div class="user-profile">
                <div class="user-avatar-large" id="userAvatar">U</div>
                <div class="user-details-large">
                    <h1 id="userName">ì‚¬ìš©ì ìƒì„¸ ë¶„ì„</h1>
                    <div class="user-info-grid">
                        <div class="info-item">
                            <span id="userEmail">ğŸ“§ ë¶„ì„ ì¤‘...</span>
                        </div>
                        <div class="info-item">
                            <span id="userDept">ğŸ¢ ë¶€ì„œ ì •ë³´ ë¡œë”©...</span>
                        </div>
                        <div class="info-item">
                            <span id="analysisPeriod">ğŸ“… ë¶„ì„ ê¸°ê°„ í™•ì¸ ì¤‘...</span>
                        </div>
                        <div class="info-item">
                            <span id="lastAccess">â° ë§ˆì§€ë§‰ ì ‘ì† ì¡°íšŒ ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <section id="baselineComparisonSection">
                <h2 class="section-title">ğŸ” ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ vs ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë¹„êµ ë¶„ì„</h2>

                <div class="baseline-comparison">
                    <div class="baseline-card common">
                        <div class="baseline-header">
                            <h3 class="baseline-title">ğŸ“Š ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ ê¸°ì¤€</h3>
                            <div id="commonScore" class="baseline-score score-common">--</div>
                        </div>
                        <div id="commonMetrics">
                            <div class="loading">ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„° ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>

                    <div class="baseline-card individual">
                        <div class="baseline-header">
                            <h3 class="baseline-title">ğŸ‘¤ ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ê¸°ì¤€</h3>
                            <div id="individualScore" class="baseline-score score-individual">--</div>
                        </div>
                        <div id="individualMetrics">
                            <div class="loading">ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„° ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="metricComparisonSection">
                <h3 class="section-title">ğŸ“ˆ ë©”íŠ¸ë¦­ë³„ ë² ì´ìŠ¤ë¼ì¸ ë¹„êµ</h3>
                <div id="metricComparisonGrid" class="metric-comparison-grid">
                    <div class="loading">ë©”íŠ¸ë¦­ ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </section>

            <section id="chartsSection">
                <h3 class="section-title">ğŸ“Š í–‰ë™ íŒ¨í„´ ì‹œê°í™”</h3>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">ì‹œê°„ëŒ€ë³„ í™œë™ íŒ¨í„´</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="timePatternChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">ì£¼ê°„ í™œë™ ë¶„í¬</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="weeklyPatternChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">ë©”íŠ¸ë¦­ í’ˆì§ˆ ì ìˆ˜</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityScoreChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">ì´ìƒì¹˜ íƒì§€ í˜„í™©</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="anomalyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>UBA Individual Baseline Analysis System v2.1 | ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ê¸°ë°˜ ì‚¬ìš©ì í–‰ë™ ë¶„ì„</p>
        </footer>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUserId = null;
        let currentProfileId = 'ce8bde1e-5b43-4790-943f-aedc076b6574'; // ì‹¤ì œ í”„ë¡œíŒŒì¼ ID
        let individualBaselines = [];
        let commonBaselines = [];
        let comparisons = [];
        let anomalies = [];
        let temporalPatterns = [];
        let qualityData = {};

        // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            currentUserId = getURLParameter('user');
            if (currentUserId) {
                initializeUserDetail(currentUserId);
            } else {
                showError('ì‚¬ìš©ì IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        });

        // ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ì´ˆê¸°í™”
        async function initializeUserDetail(userId) {
            try {
                // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ì„¤ì •
                updateUserInfo(userId);

                // API ë°ì´í„° ë¡œë“œ
                await Promise.all([
                    loadIndividualBaselines(userId),
                    loadAnomalies(userId),
                    loadTemporalPatterns(userId),
                    loadQualityData(userId)
                ]);

                // UI ì—…ë°ì´íŠ¸
                updateBaselineComparison();
                updateMetricComparison();
                updateCharts();
                updateRiskStatus();

            } catch (error) {
                console.error('ì‚¬ìš©ì ìƒì„¸ ë¶„ì„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showError('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateUserInfo(userId) {
            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');
            const email = document.getElementById('userEmail');
            const dept = document.getElementById('userDept');
            const period = document.getElementById('analysisPeriod');
            const lastAccess = document.getElementById('lastAccess');

            // ì‚¬ìš©ì ì •ë³´ (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            const userInfo = {
                name: userId === 'user0001' ? 'ê¹€ì² ìˆ˜' : `ì‚¬ìš©ì ${userId}`,
                email: `${userId}@company.com`,
                dept: 'ê°œë°œíŒ€',
                avatar: userId.charAt(userId.length - 1).toUpperCase()
            };

            avatar.textContent = userInfo.avatar;
            name.textContent = `${userInfo.name} ìƒì„¸ ë¶„ì„`;
            email.innerHTML = `ğŸ“§ ${userInfo.email}`;
            dept.innerHTML = `ğŸ¢ ${userInfo.dept}`;
            period.innerHTML = `ğŸ“… ë¶„ì„ ê¸°ê°„: ìµœê·¼ 30ì¼`;
            lastAccess.innerHTML = `â° ë§ˆì§€ë§‰ ë¶„ì„: ${new Date().toLocaleString()}`;
        }

        // ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„° ë¡œë“œ
        async function loadIndividualBaselines(userId) {
            try {
                const response = await fetch(`/api/baseline-details/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

                const data = await response.json();
                individualBaselines = data.individual_baselines || [];
                commonBaselines = data.common_baselines || [];
                comparisons = data.comparisons || [];
                console.log('ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„°:', individualBaselines);
                console.log('ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„°:', commonBaselines);
                console.log('ë¹„êµ ë°ì´í„°:', comparisons);
            } catch (error) {
                console.error('ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                individualBaselines = [];
                commonBaselines = [];
                comparisons = [];
            }
        }

        // ì´ìƒì¹˜ ë°ì´í„° ë¡œë“œ
        async function loadAnomalies(userId) {
            try {
                const response = await fetch(`/api/anomalies/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('ì´ìƒì¹˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

                const data = await response.json();
                anomalies = data.anomalies || [];
                console.log('ì´ìƒì¹˜ ë°ì´í„°:', anomalies);
            } catch (error) {
                console.error('ì´ìƒì¹˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                anomalies = [];
            }
        }

        // ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë°ì´í„° ë¡œë“œ
        async function loadTemporalPatterns(userId) {
            try {
                const response = await fetch(`/api/temporal-patterns/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

                const data = await response.json();
                temporalPatterns = data.patterns || [];
                console.log('ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë°ì´í„°:', temporalPatterns);
            } catch (error) {
                console.error('ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë¡œë“œ ì˜¤ë¥˜:', error);
                temporalPatterns = [];
            }
        }

        // í’ˆì§ˆ ë°ì´í„° ë¡œë“œ
        async function loadQualityData(userId) {
            try {
                const response = await fetch(`/api/baseline-quality/${currentProfileId}/${userId}`);
                if (!response.ok) throw new Error('í’ˆì§ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

                const data = await response.json();
                qualityData = data;
                console.log('í’ˆì§ˆ ë°ì´í„°:', qualityData);
            } catch (error) {
                console.error('í’ˆì§ˆ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                qualityData = {};
            }
        }

        // ë² ì´ìŠ¤ë¼ì¸ ë¹„êµ ì—…ë°ì´íŠ¸
        function updateBaselineComparison() {
            const commonScore = document.getElementById('commonScore');
            const individualScore = document.getElementById('individualScore');
            const commonMetrics = document.getElementById('commonMetrics');
            const individualMetrics = document.getElementById('individualMetrics');

            // ì ìˆ˜ ê³„ì‚°
            const avgQuality = individualBaselines.length > 0
                ? Math.round(individualBaselines.reduce((sum, b) => sum + b.quality_score, 0) / individualBaselines.length * 100)
                : 75;

            const commonQualityScore = 85; // ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ ê¸°ë³¸ ì ìˆ˜

            commonScore.textContent = commonQualityScore;
            individualScore.textContent = avgQuality;

            // ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ ë©”íŠ¸ë¦­
            commonMetrics.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">í‰ê·  í’ˆì§ˆ</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${commonQualityScore}%</div>
                        <div style="font-size: 0.8rem; color: #28a745;">ì•ˆì •ì </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ì‚¬ìš©ì ìˆ˜</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">187ëª…</div>
                        <div style="font-size: 0.8rem; color: #007bff;">ì „ì²´ ê¸°ì¤€</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">í•™ìŠµ ê¸°ê°„</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">30ì¼</div>
                        <div style="font-size: 0.8rem; color: #17a2b8;">í‘œì¤€</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ë©”íŠ¸ë¦­ ìˆ˜</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">15ê°œ</div>
                        <div style="font-size: 0.8rem; color: #6f42c1;">VPN ê¸°ë°˜</div>
                    </div>
                </div>
            `;

            // ê°œë³„ ë² ì´ìŠ¤ë¼ì¸ ë©”íŠ¸ë¦­
            const anomalyCount = anomalies.length;
            const dataPoints = individualBaselines.length > 0 ? individualBaselines[0].data_points_count : 1000;

            individualMetrics.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ê°œë³„ í’ˆì§ˆ</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${avgQuality}%</div>
                        <div style="font-size: 0.8rem; color: ${avgQuality >= 80 ? '#28a745' : avgQuality >= 60 ? '#ffc107' : '#dc3545'};">
                            ${avgQuality >= 80 ? 'ìš°ìˆ˜' : avgQuality >= 60 ? 'ë³´í†µ' : 'ê°œì„  í•„ìš”'}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ì´ìƒì¹˜ ìˆ˜</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${anomalyCount}ê°œ</div>
                        <div style="font-size: 0.8rem; color: ${anomalyCount > 5 ? '#dc3545' : anomalyCount > 2 ? '#ffc107' : '#28a745'};">
                            ${anomalyCount > 5 ? 'ë†’ìŒ' : anomalyCount > 2 ? 'ë³´í†µ' : 'ë‚®ìŒ'}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ë°ì´í„° í¬ì¸íŠ¸</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${dataPoints.toLocaleString()}ê°œ</div>
                        <div style="font-size: 0.8rem; color: #17a2b8;">ì¶©ë¶„í•¨</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ë¶„ì„ ë©”íŠ¸ë¦­</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${individualBaselines.length}ê°œ</div>
                        <div style="font-size: 0.8rem; color: #6f42c1;">ê°œì¸í™”ë¨</div>
                    </div>
                </div>
            `;
        }

        // ë©”íŠ¸ë¦­ë³„ ì •ìƒ ë²”ìœ„ ë¹„êµ ë°ì´í„° ì¤€ë¹„
        function prepareMetricComparisonData(metricName, individualRange, commonRange) {
            const metricConfig = {
                // ì‹œê°„ ê¸°ë°˜ ë©”íŠ¸ë¦­
                'login_time_pattern': {
                    type: 'time_based',
                    title: 'ì •ìƒ ë¡œê·¸ì¸ ì‹œê°„',
                    unit: 'ì‹œê°„',
                    chartType: 'timeline'
                },
                'after_hours_activity': {
                    type: 'time_based',
                    title: 'ì—…ë¬´ì‹œê°„ ì™¸ í™œë™ í—ˆìš©ë²”ìœ„',
                    unit: 'ì‹œê°„',
                    chartType: 'timeline'
                },
                'weekend_holiday_access': {
                    type: 'threshold',
                    title: 'ì£¼ë§/íœ´ì¼ ì ‘ì† í—ˆìš©ìˆ˜ì¤€',
                    unit: 'íšŸìˆ˜/ì£¼',
                    chartType: 'bar'
                },

                // ì„¸ì…˜ ê¸°ë°˜ ë©”íŠ¸ë¦­
                'session_duration': {
                    type: 'statistical',
                    title: 'ì •ìƒ ì„¸ì…˜ ì§€ì†ì‹œê°„',
                    unit: 'ë¶„',
                    chartType: 'range'
                },
                'concurrent_session_detection': {
                    type: 'threshold',
                    title: 'ë™ì‹œ ì„¸ì…˜ í—ˆìš©ê°œìˆ˜',
                    unit: 'ê°œ',
                    chartType: 'bar'
                },
                'login_frequency_change': {
                    type: 'statistical',
                    title: 'ë¡œê·¸ì¸ ë¹ˆë„ ë³€í™” í—ˆìš©ë²”ìœ„',
                    unit: '%',
                    chartType: 'range'
                },

                // ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë©”íŠ¸ë¦­
                'ip_address_pattern': {
                    type: 'categorical',
                    title: 'í—ˆìš© IP íŒ¨í„´',
                    unit: 'íŒ¨í„´',
                    chartType: 'text'
                },
                'geo_location_analysis': {
                    type: 'categorical',
                    title: 'í—ˆìš© ì§€ì—­ ë²”ìœ„',
                    unit: 'ì§€ì—­',
                    chartType: 'text'
                },
                'vpn_usage_pattern': {
                    type: 'statistical',
                    title: 'VPN ì‚¬ìš© íŒ¨í„´',
                    unit: 'ì‹œê°„/ì¼',
                    chartType: 'range'
                },
                'bandwidth_usage_anomaly': {
                    type: 'statistical',
                    title: 'ëŒ€ì—­í­ ì‚¬ìš©ëŸ‰ ì •ìƒë²”ìœ„',
                    unit: 'GB/ì¼',
                    chartType: 'range'
                },

                // ê¸°íƒ€ ë©”íŠ¸ë¦­
                'impossible_travel_detection': {
                    type: 'threshold',
                    title: 'ì´ë™ ì†ë„ ì„ê³„ê°’',
                    unit: 'km/h',
                    chartType: 'bar'
                },
                'network_device_change': {
                    type: 'threshold',
                    title: 'ê¸°ê¸° ë³€ê²½ í—ˆìš©ë¹ˆë„',
                    unit: 'íšŒ/ì›”',
                    chartType: 'bar'
                },
                'connection_pattern_analysis': {
                    type: 'statistical',
                    title: 'ì—°ê²° íŒ¨í„´ ì •ìƒë²”ìœ„',
                    unit: 'ì—°ê²°/ì‹œê°„',
                    chartType: 'range'
                },
                'timezone_anomaly_access': {
                    type: 'categorical',
                    title: 'í—ˆìš© ì‹œê°„ëŒ€',
                    unit: 'ì‹œê°„ëŒ€',
                    chartType: 'text'
                },
                'data_volume_transfer': {
                    type: 'statistical',
                    title: 'ë°ì´í„° ì „ì†¡ëŸ‰ ì •ìƒë²”ìœ„',
                    unit: 'GB/ì¼',
                    chartType: 'range'
                }
            };

            const config = metricConfig[metricName] || {
                type: 'statistical',
                title: 'ì •ìƒ ë²”ìœ„',
                unit: '',
                chartType: 'range'
            };

            return {
                config: config,
                individual: individualRange,
                common: commonRange
            };
        }

        // ì •ìƒ ë²”ìœ„ ë¹„êµ ì»¨í…ì¸  ìƒì„±
        function generateComparisonContent(comparisonData, qualityScore) {
            const { config, individual, common } = comparisonData;

            if (config.chartType === 'text') {
                return generateTextComparison(config, individual, common, qualityScore);
            } else if (config.type === 'time_based') {
                return generateTimeBasedComparison(config, individual, common, qualityScore);
            } else if (config.type === 'statistical') {
                return generateStatisticalComparison(config, individual, common, qualityScore);
            } else if (config.type === 'threshold') {
                return generateThresholdComparison(config, individual, common, qualityScore);
            } else {
                return generateStatisticalComparison(config, individual, common, qualityScore);
            }
        }

        // í…ìŠ¤íŠ¸ ê¸°ë°˜ ë¹„êµ (IP íŒ¨í„´, ì§€ì—­ ë“±)
        function generateTextComparison(config, individual, common, qualityScore) {
            // human_readable ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹
            let individualDisplay = individual?.human_readable;
            if (!individualDisplay) {
                if (individual?.categorical_range &&
                    typeof individual.categorical_range === 'object' &&
                    Object.keys(individual.categorical_range).length > 0) {
                    individualDisplay = Object.entries(individual.categorical_range).map(([key, value]) =>
                        `${key}: ${Array.isArray(value) ? value.join(', ') : value}`
                    ).join('<br>');
                } else {
                    individualDisplay = 'ë°ì´í„° í•™ìŠµ ì¤‘...';
                }
            }

            let commonDisplay = common?.human_readable;
            if (!commonDisplay) {
                if (common?.categorical_range &&
                    typeof common.categorical_range === 'object' &&
                    Object.keys(common.categorical_range).length > 0) {
                    commonDisplay = Object.entries(common.categorical_range).map(([key, value]) =>
                        `${key}: ${Array.isArray(value) ? value.join(', ') : value}`
                    ).join('<br>');
                } else {
                    commonDisplay = 'ë°ì´í„° í•™ìŠµ ì¤‘...';
                }
            }

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">ğŸ‘¤ ê°œë³„ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">í’ˆì§ˆ: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 1rem; font-weight: 500; color: #2980b9;">
                            ${individualDisplay}
                        </div>
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">ğŸ‘¥ ê³µí†µ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">187ëª… ê¸°ì¤€</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px;">
                        <div style="font-size: 1rem; font-weight: 500; color: #27ae60;">
                            ${commonDisplay}
                        </div>
                    </div>
                </div>
            `;
        }

        // ì‹œê°„ ê¸°ë°˜ ë¹„êµ (ë¡œê·¸ì¸ ì‹œê°„, ì—…ë¬´ì‹œê°„ ì™¸ í™œë™ ë“±)
        function generateTimeBasedComparison(config, individual, common, qualityScore) {
            // human_readable ìš°ì„  ì‚¬ìš©
            const individualDisplay = individual?.human_readable || (() => {
                const timeData = individual?.time_based_range || individual?.statistical_range || {};
                if (timeData.start_hour !== undefined && timeData.end_hour !== undefined) {
                    return `${String(timeData.start_hour).padStart(2, '0')}:00 - ${String(timeData.end_hour).padStart(2, '0')}:00`;
                } else if (timeData.mean_hour !== undefined) {
                    const meanHour = Math.round(timeData.mean_hour);
                    const stdHour = Math.round(timeData.std_deviation || 2);
                    return `${String(Math.max(0, meanHour - stdHour)).padStart(2, '0')}:00 - ${String(Math.min(23, meanHour + stdHour)).padStart(2, '0')}:00`;
                }
                return 'í•™ìŠµ ì¤‘...';
            })();

            const commonDisplay = common?.human_readable || (() => {
                const timeData = common?.time_based_range || common?.statistical_range || {};
                if (timeData.start_hour !== undefined && timeData.end_hour !== undefined) {
                    return `${String(timeData.start_hour).padStart(2, '0')}:00 - ${String(timeData.end_hour).padStart(2, '0')}:00`;
                } else if (timeData.mean_hour !== undefined) {
                    const meanHour = Math.round(timeData.mean_hour);
                    const stdHour = Math.round(timeData.std_deviation || 2);
                    return `${String(Math.max(0, meanHour - stdHour)).padStart(2, '0')}:00 - ${String(Math.min(23, meanHour + stdHour)).padStart(2, '0')}:00`;
                }
                return 'í•™ìŠµ ì¤‘...';
            })();

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">ğŸ‘¤ ê°œë³„ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">í’ˆì§ˆ: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #2980b9; margin-bottom: 4px;">
                            ğŸ• ${individualDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">ì •ìƒ í™œë™ ë²”ìœ„</div>
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">ğŸ‘¥ ê³µí†µ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">187ëª… ê¸°ì¤€</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60; margin-bottom: 4px;">
                            ğŸ• ${commonDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">ì¼ë°˜ì ì¸ í™œë™ ë²”ìœ„</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                    <div style="color: #666; text-align: center;">
                        ğŸ’¡ ì´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ í™œë™ì€ ì´ìƒ í–‰ë™ìœ¼ë¡œ ê°ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>
            `;
        }

        // í†µê³„ì  ë¹„êµ (ì„¸ì…˜ ì‹œê°„, ë¹ˆë„ ë“±)
        function generateStatisticalComparison(config, individual, common, qualityScore) {
            // human_readable ìš°ì„  ì‚¬ìš©
            const individualDisplay = individual?.human_readable || (() => {
                const stats = individual?.statistical_range || {};
                const mean = stats.mean_hour || 0;
                const std = stats.std_deviation || 0;
                return `${(mean - 2 * std).toFixed(1)} - ${(mean + 2 * std).toFixed(1)} ${config.unit}`;
            })();

            const commonDisplay = common?.human_readable || (() => {
                const stats = common?.statistical_range || {};
                const mean = stats.mean_hour || 0;
                const std = stats.std_deviation || 0;
                return `${(mean - 2 * std).toFixed(1)} - ${(mean + 2 * std).toFixed(1)} ${config.unit}`;
            })();

            // í‰ê· ê°’ë„ í‘œì‹œ (human_readableì´ ë²”ìœ„ë§Œ í¬í•¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
            const individualMean = individual?.statistical_range?.mean_hour || 0;
            const commonMean = common?.statistical_range?.mean_hour || 0;

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">ğŸ‘¤ ê°œë³„ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">í’ˆì§ˆ: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.9rem; color: #666;">ì •ìƒ ë²”ìœ„:</span>
                            <span style="font-weight: bold; color: #2980b9;">${individualDisplay}</span>
                        </div>
                        ${individualMean > 0 ? `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9rem; color: #666;">í‰ê· ê°’:</span>
                            <span style="font-weight: bold; color: #2980b9;">${individualMean.toFixed(1)} ${config.unit}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">ğŸ‘¥ ê³µí†µ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">187ëª… ê¸°ì¤€</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.9rem; color: #666;">ì •ìƒ ë²”ìœ„:</span>
                            <span style="font-weight: bold; color: #27ae60;">${commonDisplay}</span>
                        </div>
                        ${commonMean > 0 ? `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9rem; color: #666;">í‰ê· ê°’:</span>
                            <span style="font-weight: bold; color: #27ae60;">${commonMean.toFixed(1)} ${config.unit}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ì„ê³„ê°’ ê¸°ë°˜ ë¹„êµ (ë™ì‹œ ì„¸ì…˜, ê¸°ê¸° ë³€ê²½ ë“±)
        function generateThresholdComparison(config, individual, common, qualityScore) {
            // human_readable ìš°ì„  ì‚¬ìš©
            const individualDisplay = individual?.human_readable || (() => {
                const threshold = individual?.threshold_range || individual?.statistical_range || {};
                const maxValue = threshold.max_value || threshold.mean_hour || 0;
                return `â‰¤ ${maxValue.toFixed(0)} ${config.unit}`;
            })();

            const commonDisplay = common?.human_readable || (() => {
                const threshold = common?.threshold_range || common?.statistical_range || {};
                const maxValue = threshold.max_value || threshold.mean_hour || 0;
                return `â‰¤ ${maxValue.toFixed(0)} ${config.unit}`;
            })();

            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #3498db;">ğŸ‘¤ ê°œë³„ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">í’ˆì§ˆ: ${qualityScore}%</span>
                    </div>
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #2980b9; margin-bottom: 4px;">
                            ${individualDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">í—ˆìš© ì„ê³„ê°’</div>
                    </div>
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #27ae60;">ğŸ‘¥ ê³µí†µ ë² ì´ìŠ¤ë¼ì¸</span>
                        <span style="font-size: 0.9rem; color: #666;">187ëª… ê¸°ì¤€</span>
                    </div>
                    <div style="padding: 12px; background: #e8f6f0; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60; margin-bottom: 4px;">
                            ${commonDisplay}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">ì¼ë°˜ì ì¸ ì„ê³„ê°’</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                    <div style="color: #666; text-align: center;">
                        âš ï¸ ì´ ê°’ì„ ì´ˆê³¼í•˜ë©´ ì´ìƒ í–‰ë™ìœ¼ë¡œ íƒì§€ë©ë‹ˆë‹¤
                    </div>
                </div>
            `;
        }

        // ë©”íŠ¸ë¦­ ë¹„êµ ì—…ë°ì´íŠ¸
        function updateMetricComparison() {
            const container = document.getElementById('metricComparisonGrid');

            if (!individualBaselines || individualBaselines.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">ë©”íŠ¸ë¦­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ë©”íŠ¸ë¦­ í•œê¸€ ë§¤í•‘
            const metricNameMap = {
                'login_time_pattern': 'ë¡œê·¸ì¸ ì‹œê°„ íŒ¨í„´',
                'session_duration': 'ì„¸ì…˜ ì§€ì† ì‹œê°„',
                'after_hours_activity': 'ì‹œê°„ ì™¸ í™œë™',
                'weekend_holiday_access': 'ì£¼ë§/íœ´ì¼ ì ‘ì†',
                'login_frequency_change': 'ë¡œê·¸ì¸ ë¹ˆë„ ë³€í™”',
                'concurrent_session_detection': 'ë™ì‹œ ì„¸ì…˜ ê°ì§€',
                'timezone_anomaly_access': 'ì‹œê°„ëŒ€ ì´ìƒ ì ‘ì†',
                'ip_address_pattern': 'IP ì£¼ì†Œ íŒ¨í„´',
                'geo_location_analysis': 'ì§€ë¦¬ì  ìœ„ì¹˜ ë¶„ì„',
                'data_volume_transfer': 'ë°ì´í„° ì „ì†¡ëŸ‰',
                'impossible_travel_detection': 'ë¶ˆê°€ëŠ¥í•œ ì´ë™ ê°ì§€',
                'vpn_usage_pattern': 'VPN ì‚¬ìš© íŒ¨í„´',
                'network_device_change': 'ë„¤íŠ¸ì›Œí¬ ê¸°ê¸° ë³€ê²½',
                'bandwidth_usage_anomaly': 'ëŒ€ì—­í­ ì‚¬ìš© ì´ìƒ',
                'connection_pattern_analysis': 'ì—°ê²° íŒ¨í„´ ë¶„ì„'
            };

            // ìœ íš¨í•œ ë©”íŠ¸ë¦­ë§Œ í•„í„°ë§ (ì‹¤ì œ ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„°ê°€ ìˆëŠ” ê²ƒë§Œ)
            const validMetrics = individualBaselines.filter(baseline =>
                metricNameMap[baseline.metric_name] &&
                baseline.normal_range &&
                baseline.normal_range.statistical_range
            );

            // ì‹¤ì œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì•Œë¦¼
            if (validMetrics.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.95); border-radius: 15px; margin: 20px 0;">
                        <div style="font-size: 2rem; margin-bottom: 15px;">â³</div>
                        <h3 style="color: #e67e22; margin-bottom: 10px;">ë² ì´ìŠ¤ë¼ì¸ í•™ìŠµ ì§„í–‰ ì¤‘</h3>
                        <p style="color: #666; margin-bottom: 15px;">ì•„ì§ ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>í•™ìŠµ ìƒíƒœ:</strong> ë² ì´ìŠ¤ë¼ì¸ ì—”ì§„ì—ì„œ ì‚¬ìš©ì íŒ¨í„´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.<br>
                            <strong>ì˜ˆìƒ ì™„ë£Œ:</strong> ì¶©ë¶„í•œ ë°ì´í„° ìˆ˜ì§‘ í›„ ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.
                        </div>
                        <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                `;

                const titleElement = document.querySelector('#metricComparisonSection .section-title');
                if (titleElement) {
                    titleElement.innerHTML = `ğŸ“Š ë©”íŠ¸ë¦­ë³„ ë² ì´ìŠ¤ë¼ì¸ ë²”ìœ„ ë¹„êµ <span style="font-size: 1rem; color: #e67e22;">(í•™ìŠµ ì¤‘...)</span>`;
                }
                return;
            }

            let html = '';
            validMetrics.forEach((baseline, index) => {
                const metricName = metricNameMap[baseline.metric_name];
                const qualityScore = Math.round(baseline.quality_score * 100);

                // í’ˆì§ˆ ì ìˆ˜ì— ë”°ë¥¸ ìƒíƒœ ê²°ì •
                let status = 'normal';
                if (qualityScore < 60) status = 'alert';
                else if (qualityScore < 80) status = 'warning';

                // í•´ë‹¹ ë©”íŠ¸ë¦­ì˜ ì´ìƒì¹˜ ì •ë³´ ì°¾ê¸°
                const anomaly = anomalies?.find(a => a.metric_name === baseline.metric_name);

                // ê³µí†µ ë² ì´ìŠ¤ë¼ì¸ ì°¾ê¸°
                const commonBaseline = commonBaselines?.find(cb => cb.metric_name === baseline.metric_name);

                // ë¹„êµ ë°ì´í„° ì°¾ê¸°
                const comparison = comparisons?.find(c => c.metric_name === baseline.metric_name);

                // ì‹¤ì œ ë² ì´ìŠ¤ë¼ì¸ í†µê³„ê°’ ì‚¬ìš©
                const individualMean = baseline.normal_range.statistical_range.mean_hour || 0;
                const individualStd = baseline.normal_range.statistical_range.std_deviation || 1;
                const commonMean = commonBaseline?.normal_range?.statistical_range?.mean_hour || individualMean;
                const commonStd = commonBaseline?.normal_range?.statistical_range?.std_deviation || individualStd;

                // ì •ìƒ ë²”ìœ„ ë°ì´í„° ì¶”ì¶œ
                const individualNormalRange = baseline.normal_range;
                const commonNormalRange = commonBaseline?.normal_range;

                // ë©”íŠ¸ë¦­ë³„ ì •ìƒ ë²”ìœ„ ë¹„êµ ë°ì´í„° ì¤€ë¹„
                const comparisonData = prepareMetricComparisonData(baseline.metric_name, individualNormalRange, commonNormalRange);

                // ì°¨íŠ¸ ID ìƒì„±
                const chartId = `metricChart_${index}`;

                // ì •ìƒ ë²”ìœ„ ë¹„êµ ì»¨í…ì¸  ìƒì„±
                const comparisonContent = generateComparisonContent(comparisonData, qualityScore);

                html += `
                    <div class="metric-card" style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div class="metric-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="metric-name" style="font-size: 1.1rem; font-weight: bold; color: #2c3e50;">${metricName}</div>
                            <div class="metric-status status-${status}" style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;
                                ${status === 'alert' ? 'background: #e74c3c; color: white;' :
                                  status === 'warning' ? 'background: #f39c12; color: white;' :
                                  'background: #27ae60; color: white;'}">
                                ${status === 'alert' ? 'âš ï¸ ê²½ê³ ' : status === 'warning' ? 'âš¡ ì£¼ì˜' : 'âœ… ì •ìƒ'}
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1rem;">ğŸ“Š ${comparisonData.config.title}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; align-items: flex-start;">
                                <!-- ì •ìƒ ë²”ìœ„ ë¹„êµ ì •ë³´ -->
                                <div class="normal-range-comparison">
                                    ${comparisonContent}
                                </div>

                                <!-- ë©”íŠ¸ë¦­ë³„ ì°¨íŠ¸/ì‹œê°í™” -->
                                <div class="metric-visualization">
                                    ${comparisonData.config.chartType !== 'text' ?
                                        `<canvas id="${chartId}" style="max-height: 200px; max-width: 280px;"></canvas>` :
                                        '<div style="padding: 20px; text-align: center; color: #666; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">ì°¨íŠ¸ ì‹œê°í™” ì¤€ë¹„ ì¤‘</div>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // ì œëª© ì—…ë°ì´íŠ¸
            const titleElement = document.querySelector('#metricComparisonSection .section-title');
            if (titleElement) {
                titleElement.innerHTML = `ğŸ“Š ë©”íŠ¸ë¦­ë³„ ë² ì´ìŠ¤ë¼ì¸ ë²”ìœ„ ë¹„êµ <span style="font-size: 1rem; color: #666;">(ì´ ${validMetrics.length}ê°œ ë©”íŠ¸ë¦­)</span>`;
            }

            // ê° ë©”íŠ¸ë¦­ì— ëŒ€í•œ ì •ìƒ ë²”ìœ„ ì°¨íŠ¸ ìƒì„±
            setTimeout(() => {
                validMetrics.forEach((baseline, index) => {
                    const comparisonData = prepareMetricComparisonData(baseline.metric_name, baseline.normal_range,
                        commonBaselines?.find(cb => cb.metric_name === baseline.metric_name)?.normal_range);
                    if (comparisonData.config.chartType !== 'text') {
                        createMetricNormalRangeChart(comparisonData, baseline, index);
                    }
                });
            }, 100);
        }

        // ë©”íŠ¸ë¦­ë³„ ì •ìƒ ë²”ìœ„ ì°¨íŠ¸ ìƒì„±
        function createMetricNormalRangeChart(comparisonData, baseline, index) {
            const chartId = `metricChart_${index}`;
            const ctx = document.getElementById(chartId);
            if (!ctx) return;

            const { config, individual, common } = comparisonData;

            // ì°¨íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ë¶„ê¸°
            if (config.chartType === 'timeline') {
                createTimelineChart(ctx, config, individual, common);
            } else if (config.chartType === 'range') {
                createRangeChart(ctx, config, individual, common);
            } else if (config.chartType === 'bar') {
                createThresholdChart(ctx, config, individual, common);
            } else {
                createDefaultChart(ctx, config, individual, common);
            }
        }

        // ì‹œê°„ëŒ€ë³„ ì°¨íŠ¸ (ë¡œê·¸ì¸ ì‹œê°„, ì—…ë¬´ì‹œê°„ ì™¸ í™œë™)
        function createTimelineChart(ctx, config, individual, common) {
            const hours = Array.from({length: 24}, (_, i) => i);
            const individualTime = individual?.time_based_range || individual?.statistical_range || {};
            const commonTime = common?.time_based_range || common?.statistical_range || {};

            // ì •ìƒ ì‹œê°„ëŒ€ ë²”ìœ„ ê³„ì‚°
            const getTimeRange = (timeData) => {
                if (timeData.start_hour !== undefined && timeData.end_hour !== undefined) {
                    return { start: timeData.start_hour, end: timeData.end_hour };
                } else if (timeData.mean_hour !== undefined) {
                    const mean = timeData.mean_hour;
                    const std = timeData.std_deviation || 2;
                    return { start: Math.max(0, mean - std), end: Math.min(23, mean + std) };
                }
                return { start: 9, end: 18 }; // ê¸°ë³¸ê°’
            };

            const individualRange = getTimeRange(individualTime);
            const commonRange = getTimeRange(commonTime);

            const individualData = hours.map(h =>
                h >= individualRange.start && h <= individualRange.end ? 1 : 0
            );
            const commonData = hours.map(h =>
                h >= commonRange.start && h <= commonRange.end ? 0.8 : 0
            );

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'ê°œë³„ ì •ìƒì‹œê°„',
                            data: individualData,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: 'ê³µí†µ ì •ìƒì‹œê°„',
                            data: commonData,
                            backgroundColor: 'rgba(39, 174, 96, 0.6)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 10 } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { font: { size: 8 }, maxTicksLimit: 8 }
                        },
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: { font: { size: 8 }, display: false }
                        }
                    }
                }
            });
        }

        // ë²”ìœ„ ì°¨íŠ¸ (ì„¸ì…˜ ì‹œê°„, ë¹ˆë„ ë“±)
        function createRangeChart(ctx, config, individual, common) {
            const individualStats = individual?.statistical_range || {};
            const commonStats = common?.statistical_range || {};

            const individualMean = individualStats.mean_hour || 0;
            const individualStd = individualStats.std_deviation || 0;
            const commonMean = commonStats.mean_hour || individualMean;
            const commonStd = commonStats.std_deviation || individualStd;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ê°œë³„', 'ê³µí†µ'],
                    datasets: [
                        {
                            label: 'í‰ê· ê°’',
                            data: [individualMean, commonMean],
                            backgroundColor: ['rgba(52, 152, 219, 0.6)', 'rgba(39, 174, 96, 0.6)'],
                            borderColor: ['#3498db', '#27ae60'],
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.unit,
                                font: { size: 9 }
                            },
                            ticks: { font: { size: 8 } }
                        }
                    }
                }
            });
        }

        // ì„ê³„ê°’ ì°¨íŠ¸ (ë™ì‹œ ì„¸ì…˜, ê¸°ê¸° ë³€ê²½)
        function createThresholdChart(ctx, config, individual, common) {
            const individualThreshold = individual?.threshold_range || individual?.statistical_range || {};
            const commonThreshold = common?.threshold_range || common?.statistical_range || {};

            const individualMax = individualThreshold.max_value || individualThreshold.mean_hour || 0;
            const commonMax = commonThreshold.max_value || commonThreshold.mean_hour || individualMax;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ê°œë³„ ì„ê³„ê°’', 'ê³µí†µ ì„ê³„ê°’'],
                    datasets: [{
                        data: [individualMax, commonMax],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(39, 174, 96, 0.8)'
                        ],
                        borderColor: ['#3498db', '#27ae60'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { font: { size: 9 } }
                        }
                    }
                }
            });
        }

        // ê¸°ë³¸ ì°¨íŠ¸
        function createDefaultChart(ctx, config, individual, common) {
            createRangeChart(ctx, config, individual, common);
        }

        // ìœ„í—˜ë„ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateRiskStatus() {
            const riskStatus = document.getElementById('riskStatus');

            if (!individualBaselines || individualBaselines.length === 0) {
                riskStatus.textContent = 'ë¶„ì„ ì¤‘...';
                riskStatus.className = 'risk-status normal';
                return;
            }

            const avgQuality = individualBaselines.reduce((sum, b) => sum + b.quality_score, 0) / individualBaselines.length * 100;
            const anomalyCount = anomalies.length;

            let riskLevel = 'normal';
            let riskText = 'ì •ìƒ';

            if (anomalyCount > 5 || avgQuality < 60) {
                riskLevel = 'high';
                riskText = 'ê³ ìœ„í—˜';
            } else if (anomalyCount > 2 || avgQuality < 80) {
                riskLevel = 'medium';
                riskText = 'ì£¼ì˜';
            }

            riskStatus.textContent = riskText;
            riskStatus.className = `risk-status ${riskLevel}`;
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts() {
            updateTimePatternChart();
            updateWeeklyPatternChart();
            updateQualityScoreChart();
            updateAnomalyChart();
        }

        // ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ì°¨íŠ¸
        function updateTimePatternChart() {
            const ctx = document.getElementById('timePatternChart').getContext('2d');

            // ì‹¤ì œ ë°ì´í„° ë˜ëŠ” ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
            const hours = Array.from({length: 24}, (_, i) => i);
            const baselineData = hours.map(() => Math.random() * 50 + 25);
            const currentData = hours.map(() => Math.random() * 60 + 20);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'ê°œë³„ ë² ì´ìŠ¤ë¼ì¸',
                        data: baselineData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }, {
                        label: 'í˜„ì¬ íŒ¨í„´',
                        data: currentData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'í™œë™ ë¹ˆë„ (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì‹œê°„'
                            }
                        }
                    }
                }
            });
        }

        // ì£¼ê°„ íŒ¨í„´ ì°¨íŠ¸
        function updateWeeklyPatternChart() {
            const ctx = document.getElementById('weeklyPatternChart').getContext('2d');

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼', 'ì¼ìš”ì¼'],
                    datasets: [{
                        label: 'ê°œë³„ ë² ì´ìŠ¤ë¼ì¸',
                        data: [85, 90, 88, 92, 87, 15, 8],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderWidth: 2
                    }, {
                        label: 'í˜„ì¬ íŒ¨í„´',
                        data: [88, 85, 90, 95, 89, 45, 35],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // í’ˆì§ˆ ì ìˆ˜ ì°¨íŠ¸
        function updateQualityScoreChart() {
            const ctx = document.getElementById('qualityScoreChart').getContext('2d');

            if (!individualBaselines || individualBaselines.length === 0) {
                ctx.fillText('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 100, 100);
                return;
            }

            const metricNames = individualBaselines
                .filter(b => b.metric_name !== 'data_volume_transfer')
                .map(baseline => {
                    const nameMap = {
                        'login_time_pattern': 'ë¡œê·¸ì¸ ì‹œê°„',
                        'session_duration': 'ì„¸ì…˜ ì§€ì†',
                        'vpn_usage_pattern': 'VPN ì‚¬ìš©',
                        'geo_location_analysis': 'ìœ„ì¹˜ ë¶„ì„'
                    };
                    return nameMap[baseline.metric_name] || baseline.metric_name.substring(0, 8);
                }).slice(0, 8);

            const qualityScores = individualBaselines
                .filter(b => b.metric_name !== 'data_volume_transfer')
                .map(baseline => Math.round(baseline.quality_score * 100))
                .slice(0, 8);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: metricNames,
                    datasets: [{
                        label: 'í’ˆì§ˆ ì ìˆ˜ (%)',
                        data: qualityScores,
                        backgroundColor: qualityScores.map(score =>
                            score >= 80 ? '#27ae60' : score >= 60 ? '#f39c12' : '#e74c3c'
                        ),
                        borderColor: '#2c3e50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'í’ˆì§ˆ ì ìˆ˜ (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ë©”íŠ¸ë¦­'
                            }
                        }
                    }
                }
            });
        }

        // ì´ìƒì¹˜ íƒì§€ ì°¨íŠ¸
        function updateAnomalyChart() {
            const ctx = document.getElementById('anomalyChart').getContext('2d');

            const anomalyCount = anomalies.length;
            const normalCount = individualBaselines.length - anomalyCount;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ì •ìƒ', 'ì´ìƒì¹˜ íƒì§€'],
                    datasets: [{
                        data: [normalCount, anomalyCount],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            const main = document.querySelector('.main-content');
            main.innerHTML = `<div class="error">âŒ ${message}</div>`;
        }

        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        document.addEventListener('DOMContentLoaded', function() {
            // ì°¨íŠ¸ ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
                document.querySelectorAll('.chart-card').forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';

                    setTimeout(() => {
                        card.style.transition = 'all 0.6s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 200);
                });
            }, 1000);

            // ë² ì´ìŠ¤ë¼ì¸ ì¹´ë“œ í˜¸ë²„ íš¨ê³¼
            document.querySelectorAll('.baseline-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                    this.style.boxShadow = '0 15px 30px rgba(0, 0, 0, 0.15)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                    this.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.1)';
                });
            });
        });
    </script>
</body>
</html>
